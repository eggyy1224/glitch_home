<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>後端控制台 MVP</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --bg: #0f172a;
        --card: rgba(15, 23, 42, 0.72);
        --border: rgba(255, 255, 255, 0.08);
        --text: #f8fafc;
        --accent: #38bdf8;
      }

      body {
        margin: 0;
        background: linear-gradient(180deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
        color: var(--text);
      }

      header {
        padding: 24px 32px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(15, 23, 42, 0.82);
        backdrop-filter: blur(10px);
      }

      header h1 {
        margin: 0;
        font-size: 24px;
        letter-spacing: 0.05em;
      }

      main {
        padding: 24px 32px 48px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 24px;
      }

      section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.35);
      }

      section h2 {
        margin: 0 0 12px;
        font-size: 18px;
      }

      label {
        display: block;
        font-size: 13px;
        margin-top: 10px;
        opacity: 0.85;
      }

      input[type="text"],
      input[type="number"],
      textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        margin-top: 6px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text);
        font-size: 13px;
        resize: vertical;
      }

      textarea {
        min-height: 90px;
        font-family: "JetBrains Mono", "Cascadia Code", "Menlo", monospace;
      }

      button {
        margin-top: 14px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 7px 16px;
        font-size: 13px;
        background: rgba(56, 189, 248, 0.15);
        color: var(--text);
        border: 1px solid rgba(56, 189, 248, 0.45);
        border-radius: 999px;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      button:hover {
        background: rgba(56, 189, 248, 0.35);
        transform: translateY(-1px);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin-top: 12px;
      }

      th,
      td {
        padding: 6px 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        text-align: left;
      }

      pre {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 12px;
        font-size: 12px;
        max-height: 180px;
        overflow: auto;
      }

      .inline-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .inline-controls label {
        flex: 1 0 140px;
        margin-top: 0;
      }

      .inline-controls input,
      .inline-controls select {
        margin-top: 4px;
      }

      small {
        opacity: 0.7;
        display: block;
        margin-top: 4px;
        font-size: 12px;
      }

      .hint {
        font-size: 12px;
        opacity: 0.65;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>後端導播控制台 · MVP</h1>
      <p class="hint">先求能動：所有操作直接呼叫 FastAPI，WebSocket 事件顯示於底部日誌。</p>
    </header>
    <main>
      <section id="section-clients">
        <h2>客戶端監控</h2>
        <div class="inline-controls">
          <label>
            Client ID (查詢/套用)
            <input type="text" id="client-focus" placeholder="desktop / integration_test" />
          </label>
          <label>
            自動更新
            <select id="auto-refresh">
              <option value="off">手動</option>
              <option value="5">每 5 秒</option>
              <option value="15">每 15 秒</option>
            </select>
          </label>
        </div>
        <button id="refresh-clients">重新整理列表</button>
        <table>
          <thead>
            <tr>
              <th>client_id</th>
              <th>連線數</th>
              <th>能力</th>
              <th>最後心跳</th>
            </tr>
          </thead>
          <tbody id="clients-table-body"></tbody>
        </table>
        <pre id="client-details">選擇 client 後顯示詳細狀態...</pre>
      </section>

      <section>
        <h2>顯示狀態控制</h2>
        <form id="display-form">
          <label>
            client_id
            <input type="text" name="client_id" placeholder="desktop" />
          </label>
          <label>
            mode
            <input type="text" name="mode" placeholder="collage / iframe / slide" required />
          </label>
          <label>
            params JSON
            <textarea name="params" placeholder='{"images": ["img_001.png"]}'></textarea>
          </label>
          <label>
            expires_in (秒，可省略)
            <input type="number" name="expires_in" min="0" step="1" />
          </label>
          <button type="submit">套用顯示狀態</button>
          <button type="button" id="load-display-state">讀取目前狀態</button>
        </form>
        <pre id="display-state-view">尚未讀取...</pre>
      </section>

      <section>
        <h2>Collage 快捷</h2>
        <form id="collage-form">
          <label>
            client_id
            <input type="text" name="client_id" placeholder="desktop2" required />
          </label>
          <label>
            圖像列表（以逗號分隔）
            <input type="text" name="images" placeholder="offspring_xxx.png,offspring_yyy.png" />
          </label>
          <div class="inline-controls">
            <label>
              rows
              <input type="number" name="rows" value="6" min="1" max="50" />
            </label>
            <label>
              cols
              <input type="number" name="cols" value="6" min="1" max="50" />
            </label>
            <label>
              mix
              <select name="mix">
                <option value="false">false</option>
                <option value="true">true</option>
              </select>
            </label>
          </div>
          <div class="inline-controls">
            <label>
              stage_width
              <input type="number" name="stage_width" min="100" step="10" />
            </label>
            <label>
              stage_height
              <input type="number" name="stage_height" min="100" step="10" />
            </label>
            <label>
              shuffle_seed
              <input type="number" name="shuffle_seed" step="1" />
            </label>
          </div>
          <label>
            其他參數 JSON
            <textarea name="extra_params" placeholder='{"images_base": "generated_images"}'></textarea>
          </label>
          <button type="submit">套用 Collage</button>
        </form>
      </section>

      <section>
        <h2>容器佈局</h2>
        <form id="layout-form">
          <label>
            target_client_id
            <input type="text" name="target_client_id" placeholder="desktop" />
          </label>
          <label>
            JSON 內容
            <textarea name="layout_json" id="layout-json" placeholder='{ "layout": "grid", ... }'></textarea>
          </label>
          <button type="button" id="load-layout">讀取佈局</button>
          <button type="submit">儲存並廣播</button>
        </form>
      </section>

      <section>
        <h2>字幕 / Caption</h2>
        <form id="subtitle-form">
          <label>
            target_client_id
            <input type="text" name="client_id" placeholder="desktop" />
          </label>
          <label>
            文字內容
            <textarea name="text" placeholder="字幕內容"></textarea>
          </label>
          <label>
            語言（選填）
            <input type="text" name="language" placeholder="zh-TW" />
          </label>
          <label>
            顯示秒數（選填）
            <input type="number" name="duration" min="0" step="1" />
          </label>
          <button type="submit">推送字幕</button>
          <button type="button" id="clear-subtitle">清除字幕</button>
        </form>
        <div class="hint">Caption API 與字幕相同，可改 client_id 呼叫。</div>
      </section>

      <section>
        <h2>音效 / TTS</h2>
        <div class="inline-controls">
          <label>
            target_client_id
            <input type="text" id="audio-client" placeholder="desktop" />
          </label>
          <label>
            可用音效
            <select id="sound-select"></select>
          </label>
        </div>
        <button id="refresh-sounds">重新載入音效清單</button>
        <button id="play-sound">播放音效</button>

        <form id="tts-form">
          <label>
            TTS 文字
            <textarea name="text" placeholder="請輸入要轉成語音的文字"></textarea>
          </label>
          <label>
            指示（選填，例如：zh-TW Mandarin, calm）
            <input type="text" name="instructions" />
          </label>
          <label>
            語音（選填，例如：alloy）
            <input type="text" name="voice" />
          </label>
          <label>
            自動播放
            <select name="auto_play">
              <option value="true">true</option>
              <option value="false" selected>false</option>
            </select>
          </label>
          <button type="submit">產生 TTS</button>
        </form>
      </section>

      <section style="grid-column: 1 / -1">
        <h2>即時事件日誌（WebSocket）</h2>
        <pre id="event-log"></pre>
      </section>
    </main>

    <script>
      const apiBase = window.location.origin;

      function logEvent(message, type = "info") {
        const logEl = document.getElementById("event-log");
        const stamp = new Date().toISOString();
        const line = `[${stamp}] (${type}) ${message}`;
        logEl.textContent = `${line}\n${logEl.textContent}`.slice(0, 8000);
      }

      async function requestJSON(url, options = {}) {
        const response = await fetch(url, {
          headers: { "Content-Type": "application/json" },
          ...options,
        });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`${response.status} ${response.statusText}: ${errorText}`);
        }
        if (response.status === 204) {
          return null;
        }
        return response.json();
      }

      function parseJSON(text, fallback) {
        if (!text) return fallback;
        try {
          return JSON.parse(text);
        } catch (err) {
          throw new Error("JSON 解析失敗: " + err.message);
        }
      }

      function updateClientDetails(client) {
        const view = document.getElementById("client-details");
        if (!client) {
          view.textContent = "尚未選擇 client";
          return;
        }
        view.textContent = JSON.stringify(client, null, 2);
      }

      async function refreshClients() {
        try {
          const data = await fetch(`${apiBase}/api/clients`).then((res) => res.json());
          const tbody = document.getElementById("clients-table-body");
          tbody.innerHTML = "";
          const focus = document.getElementById("client-focus").value.trim();
          let focusRecord = null;
          data.clients.forEach((client) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${client.client_id ?? "<全域>"}</td>
              <td>${client.connections}</td>
              <td>${(client.capabilities || []).join(", ")}</td>
              <td>${client.last_heartbeat ?? "-"}</td>
            `;
            tr.addEventListener("click", () => {
              document.getElementById("client-focus").value = client.client_id ?? "";
              updateClientDetails(client);
            });
            tbody.appendChild(tr);
            if (focus && client.client_id === focus) {
              focusRecord = client;
            }
          });
          if (!focus && data.clients.length) {
            updateClientDetails(data.clients[0]);
          } else if (focusRecord) {
            updateClientDetails(focusRecord);
          }
        } catch (err) {
          logEvent(`載入 clients 失敗: ${err.message}`, "error");
        }
      }

      document.getElementById("refresh-clients").addEventListener("click", refreshClients);

      document.getElementById("auto-refresh").addEventListener("change", (event) => {
        if (window.__autoTimer) {
          clearInterval(window.__autoTimer);
          window.__autoTimer = null;
        }
        const value = event.target.value;
        if (value !== "off") {
          const interval = Number(value) * 1000;
          window.__autoTimer = setInterval(refreshClients, interval);
        }
      });

      document.getElementById("display-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const form = event.currentTarget;
        const clientId = form.client_id.value.trim();
        if (!clientId) {
          alert("請輸入 client_id");
          return;
        }
        let params;
        try {
          params = parseJSON(form.params.value, {});
        } catch (err) {
          alert(err.message);
          return;
        }
        const payload = {
          mode: form.mode.value.trim(),
          params,
          frames: [],
        };
        const expiresIn = form.expires_in.value;
        if (expiresIn) {
          payload.expires_in = Number(expiresIn);
        }
        try {
          const result = await requestJSON(`${apiBase}/api/clients/${encodeURIComponent(clientId)}/display`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          document.getElementById("display-state-view").textContent = JSON.stringify(result, null, 2);
          logEvent(`更新 ${clientId} display_state 成功`);
        } catch (err) {
          alert(err.message);
          logEvent(`更新 display_state 失敗: ${err.message}`, "error");
        }
      });

      document.getElementById("load-display-state").addEventListener("click", async () => {
        const clientId = document.getElementById("client-focus").value.trim();
        try {
          const url = clientId
            ? `${apiBase}/api/clients/${encodeURIComponent(clientId)}/display`
            : `${apiBase}/api/display`;
          const result = await fetch(url).then((res) => res.json());
          document.getElementById("display-state-view").textContent = JSON.stringify(result, null, 2);
          logEvent(`讀取 ${clientId || "<全域>"} display_state`);
        } catch (err) {
          alert(err.message);
          logEvent(`讀取 display_state 失敗: ${err.message}`, "error");
        }
      });

      document.getElementById("collage-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const form = event.currentTarget;
        const clientId = form.client_id.value.trim();
        if (!clientId) {
          alert("請輸入 client_id");
          return;
        }
        const images = form.images.value
          .split(",")
          .map((item) => item.trim())
          .filter(Boolean);
        let extraParams = {};
        try {
          extraParams = parseJSON(form.extra_params.value, {});
        } catch (err) {
          alert(err.message);
          return;
        }
        const payload = {
          images,
          rows: Number(form.rows.value || 6),
          cols: Number(form.cols.value || 6),
          mix: form.mix.value === "true",
          shuffle_seed: form.shuffle_seed.value ? Number(form.shuffle_seed.value) : null,
          stage_width: form.stage_width.value ? Number(form.stage_width.value) : null,
          stage_height: form.stage_height.value ? Number(form.stage_height.value) : null,
          params: extraParams,
        };
        try {
          const result = await requestJSON(`${apiBase}/api/clients/${encodeURIComponent(clientId)}/collage`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          document.getElementById("display-state-view").textContent = JSON.stringify(result, null, 2);
          logEvent(`套用 collage 至 ${clientId}`);
        } catch (err) {
          alert(err.message);
          logEvent(`Collage 設定失敗: ${err.message}`, "error");
        }
      });

      document.getElementById("layout-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const form = event.currentTarget;
        const clientId = form.target_client_id.value.trim();
        let payload;
        try {
          payload = parseJSON(form.layout_json.value, {});
        } catch (err) {
          alert(err.message);
          return;
        }
        if (clientId) {
          payload.target_client_id = clientId;
        }
        try {
          const result = await requestJSON(`${apiBase}/api/container-layout`, {
            method: "PUT",
            body: JSON.stringify(payload),
          });
          document.getElementById("layout-json").value = JSON.stringify(result.raw ?? result, null, 2);
          logEvent(`更新 container_layout (${clientId || "全域"}) 成功`);
        } catch (err) {
          alert(err.message);
          logEvent(`更新 container_layout 失敗: ${err.message}`, "error");
        }
      });

      document.getElementById("load-layout").addEventListener("click", async () => {
        const clientId = document.getElementById("client-focus").value.trim() || null;
        const url = clientId
          ? `${apiBase}/api/container-layout?client=${encodeURIComponent(clientId)}`
          : `${apiBase}/api/container-layout`;
        try {
          const result = await fetch(url).then((res) => res.json());
          document.getElementById("layout-json").value = JSON.stringify(result.raw ?? result, null, 2);
          logEvent(`讀取 container_layout (${clientId || "全域"})`);
        } catch (err) {
          alert(err.message);
          logEvent(`讀取 container_layout 失敗: ${err.message}`, "error");
        }
      });

      document.getElementById("subtitle-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const form = event.currentTarget;
        const clientId = form.client_id.value.trim();
        const payload = {
          text: form.text.value,
          language: form.language.value || null,
          duration_seconds: form.duration.value ? Number(form.duration.value) : null,
        };
        try {
          await requestJSON(`${apiBase}/api/subtitles?target_client_id=${encodeURIComponent(clientId)}`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          logEvent(`推送字幕給 ${clientId || "全部"}`);
        } catch (err) {
          alert(err.message);
          logEvent(`字幕推送失敗: ${err.message}`, "error");
        }
      });

      document.getElementById("clear-subtitle").addEventListener("click", async () => {
        const clientId = document.getElementById("subtitle-form").client_id.value.trim();
        try {
          await fetch(`${apiBase}/api/subtitles?target_client_id=${encodeURIComponent(clientId)}`, {
            method: "DELETE",
          });
          logEvent(`已清除字幕 (${clientId || "全部"})`);
        } catch (err) {
          alert(err.message);
          logEvent(`清除字幕失敗: ${err.message}`, "error");
        }
      });

      async function refreshSoundList() {
        try {
          const res = await fetch(`${apiBase}/api/sound-files`);
          const data = await res.json();
          const select = document.getElementById("sound-select");
          select.innerHTML = "";
          (data.files || []).forEach((file) => {
            const option = document.createElement("option");
            option.value = file.filename;
            option.textContent = file.filename;
            select.appendChild(option);
          });
          logEvent("重新載入音效清單");
        } catch (err) {
          logEvent(`讀取音效清單失敗: ${err.message}`, "error");
        }
      }

      document.getElementById("refresh-sounds").addEventListener("click", refreshSoundList);

      document.getElementById("play-sound").addEventListener("click", async () => {
        const filename = document.getElementById("sound-select").value;
        if (!filename) {
          alert("請先選擇音效");
          return;
        }
        const clientId = document.getElementById("audio-client").value.trim();
        try {
          await requestJSON(`${apiBase}/api/sound-play`, {
            method: "POST",
            body: JSON.stringify({ filename, target_client_id: clientId || null }),
          });
          logEvent(`音效 ${filename} 佇列成功 (${clientId || "全部"})`);
        } catch (err) {
          alert(err.message);
          logEvent(`音效播放失敗: ${err.message}`, "error");
        }
      });

      document.getElementById("tts-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const form = event.currentTarget;
        const clientId = document.getElementById("audio-client").value.trim();
        const payload = {
          text: form.text.value,
          instructions: form.instructions.value || null,
          voice: form.voice.value || null,
          auto_play: form.auto_play.value === "true",
          target_client_id: clientId || null,
        };
        try {
          const result = await requestJSON(`${apiBase}/api/tts`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          logEvent(`TTS 已產生${payload.auto_play ? "並播放" : ""}`);
          alert("TTS 完成，詳見日誌與返回 JSON");
          console.info(result);
        } catch (err) {
          alert(err.message);
          logEvent(`TTS 失敗: ${err.message}`, "error");
        }
      });

      function setupWebSocket() {
        const base = apiBase.replace(/^http/, "ws");
        const socket = new WebSocket(`${base}/ws/screenshots`);
        socket.addEventListener("open", () => {
          socket.send(
            JSON.stringify({
              type: "hello",
              client_id: "admin_console",
              capabilities: ["controller"],
            }),
          );
          logEvent("WebSocket 已連線", "ws");
        });
        socket.addEventListener("message", (event) => {
          logEvent(event.data, "event");
        });
        socket.addEventListener("close", () => {
          logEvent("WebSocket 已關閉，2 秒後重連", "ws");
          setTimeout(setupWebSocket, 2000);
        });
        socket.addEventListener("error", (err) => {
          logEvent(`WebSocket 發生錯誤: ${err.message}`, "error");
        });
      }

      refreshClients();
      refreshSoundList();
      setupWebSocket();
    </script>
  </body>
</html>
