<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>後端控制台</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --bg: #0f172a;
        --card: rgba(15, 23, 42, 0.72);
        --border: rgba(255, 255, 255, 0.08);
        --text: #f8fafc;
        --accent: #38bdf8;
        --accent-hover: #0ea5e9;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: linear-gradient(180deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
        color: var(--text);
      }

      header {
        padding: 24px 32px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(15, 23, 42, 0.82);
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      header h1 {
        margin: 0;
        font-size: 24px;
        letter-spacing: 0.05em;
      }

      .back-btn {
        display: none;
        padding: 8px 16px;
        font-size: 14px;
        background: rgba(56, 189, 248, 0.15);
        color: var(--text);
        border: 1px solid rgba(56, 189, 248, 0.45);
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .back-btn:hover {
        background: rgba(56, 189, 248, 0.35);
      }

      .back-btn.visible {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      main {
        padding: 24px 32px 48px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* 主頁面：Client 列表 */
      #client-list-view {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .client-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.35);
      }

      .client-card:hover {
        border-color: rgba(56, 189, 248, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.5);
      }

      .client-card h3 {
        margin: 0 0 12px;
        font-size: 18px;
        color: var(--accent);
      }

      .client-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 13px;
        opacity: 0.8;
        margin-bottom: 12px;
      }

      .client-meta span {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .client-status {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
        margin-right: 6px;
      }

      .client-status.offline {
        background: #ef4444;
      }

      /* 詳細頁面：Client 控制 */
      #client-detail-view {
        display: none;
      }

      #client-detail-view.active {
        display: block;
      }

      .client-header {
        margin-bottom: 24px;
      }

      .client-header h2 {
        margin: 0 0 8px;
        font-size: 22px;
      }

      .client-info {
        display: flex;
        gap: 16px;
        font-size: 13px;
        opacity: 0.7;
        margin-bottom: 24px;
      }

      section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.35);
      }

      section h3 {
        margin: 0 0 16px;
        font-size: 16px;
        color: var(--accent);
      }

      .control-group {
        margin-bottom: 20px;
      }

      .control-group:last-child {
        margin-bottom: 0;
      }

      label {
        display: block;
        font-size: 13px;
        margin-bottom: 8px;
        opacity: 0.85;
      }

      .slider-control {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      input[type="range"] {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
        outline: none;
        -webkit-appearance: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
      }

      input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
        border: none;
      }

      input[type="number"],
      input[type="text"],
      textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text);
        font-size: 13px;
      }

      input[type="number"] {
        width: 80px;
        flex-shrink: 0;
      }

      textarea {
        min-height: 90px;
        font-family: "JetBrains Mono", "Cascadia Code", "Menlo", monospace;
        resize: vertical;
      }

      .checkbox-control {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      button {
        padding: 8px 16px;
        font-size: 13px;
        background: rgba(56, 189, 248, 0.15);
        color: var(--text);
        border: 1px solid rgba(56, 189, 248, 0.45);
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      button:hover {
        background: rgba(56, 189, 248, 0.35);
        transform: translateY(-1px);
      }

      button.primary {
        background: rgba(56, 189, 248, 0.3);
        border-color: rgba(56, 189, 248, 0.6);
      }

      button.primary:hover {
        background: rgba(56, 189, 248, 0.5);
      }

      .button-group {
        display: flex;
        gap: 8px;
        margin-top: 16px;
      }

      .mode-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
      }

      .mode-btn {
        flex: 1;
        padding: 10px;
        text-align: center;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .mode-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .mode-btn.active {
        background: rgba(56, 189, 248, 0.2);
        border-color: rgba(56, 189, 248, 0.5);
        color: var(--accent);
      }

      .image-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 8px;
        margin-top: 8px;
      }

      .image-item {
        padding: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 11px;
        text-align: center;
        word-break: break-all;
      }

      .status-display {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 12px;
        font-size: 12px;
        font-family: "JetBrains Mono", "Cascadia Code", "Menlo", monospace;
        max-height: 200px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .event-log {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 12px;
        font-size: 11px;
        font-family: "JetBrains Mono", "Cascadia Code", "Menlo", monospace;
        max-height: 300px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        opacity: 0.6;
      }

      .loading {
        text-align: center;
        padding: 20px;
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>後端導播控制台</h1>
      <button class="back-btn" id="back-btn">← 返回列表</button>
    </header>

    <main>
      <!-- 主頁面：Client 列表 -->
      <div id="client-list-view">
        <div class="loading">載入中...</div>
      </div>

      <!-- 詳細頁面：Client 控制 -->
      <div id="client-detail-view">
        <div class="client-header">
          <h2 id="detail-client-name">-</h2>
          <div class="client-info">
            <span>連線數: <span id="detail-connections">-</span></span>
            <span>能力: <span id="detail-capabilities">-</span></span>
            <span>最後心跳: <span id="detail-heartbeat">-</span></span>
          </div>
        </div>

        <!-- 顯示模式選擇 -->
        <section>
          <h3>顯示模式</h3>
          <div class="mode-selector">
            <button class="mode-btn" data-mode="collage">Collage</button>
            <button class="mode-btn" data-mode="iframe">Iframe</button>
            <button class="mode-btn" data-mode="slide">Slide</button>
            <button class="mode-btn" data-mode="default">預設</button>
          </div>
        </section>

        <!-- Collage 模式控制 -->
        <section id="collage-controls" style="display: none;">
          <h3>Collage 設定</h3>
          <div class="control-group">
            <label>圖片數量</label>
            <div class="slider-control">
              <input type="range" id="collage-image-count" min="1" max="30" value="4" />
              <input type="number" id="collage-image-count-num" min="1" max="30" value="4" />
            </div>
          </div>
          <div class="control-group">
            <label>切片列數 (Rows)</label>
            <div class="slider-control">
              <input type="range" id="collage-rows" min="1" max="96" value="3" />
              <input type="number" id="collage-rows-num" min="1" max="96" value="3" />
            </div>
          </div>
          <div class="control-group">
            <label>切片行數 (Cols)</label>
            <div class="slider-control">
              <input type="range" id="collage-cols" min="1" max="96" value="3" />
              <input type="number" id="collage-cols-num" min="1" max="96" value="3" />
            </div>
          </div>
          <div class="control-group">
            <div class="checkbox-control">
              <input type="checkbox" id="collage-mix" />
              <label for="collage-mix" style="margin: 0;">混合拼貼</label>
            </div>
          </div>
          <div class="control-group">
            <label>圖像列表（以逗號分隔）</label>
            <textarea id="collage-images" placeholder="offspring_xxx.png,offspring_yyy.png"></textarea>
            <div class="image-list" id="collage-image-list"></div>
          </div>
          <div class="button-group">
            <button class="primary" id="apply-collage">套用 Collage</button>
            <button id="shuffle-collage">重新打散</button>
          </div>
        </section>

        <!-- Iframe 模式控制 -->
        <section id="iframe-controls" style="display: none;">
          <h3>Iframe 多格設定</h3>
          <div class="control-group">
            <label>佈局模式</label>
            <select id="iframe-layout">
              <option value="grid">網格 (Grid)</option>
              <option value="horizontal">水平排列</option>
              <option value="vertical">垂直排列</option>
            </select>
          </div>
          <div class="control-group">
            <label>間距 (Gap)</label>
            <div class="slider-control">
              <input type="range" id="iframe-gap" min="0" max="50" value="12" />
              <input type="number" id="iframe-gap-num" min="0" max="50" value="12" />
            </div>
          </div>
          <div class="control-group" id="iframe-columns-group">
            <label>欄數 (Columns，僅 Grid 模式)</label>
            <div class="slider-control">
              <input type="range" id="iframe-columns" min="1" max="8" value="2" />
              <input type="number" id="iframe-columns-num" min="1" max="8" value="2" />
            </div>
          </div>
          <div class="control-group">
            <label>面板列表 (Panels)</label>
            <div id="iframe-panels-list"></div>
            <button type="button" id="add-iframe-panel" style="margin-top: 8px;">+ 新增面板</button>
          </div>
          <div class="button-group">
            <button class="primary" id="apply-iframe">套用 Iframe</button>
            <button id="load-iframe-config">讀取 Iframe 配置</button>
          </div>
        </section>

        <!-- 其他模式控制 -->
        <section id="other-controls" style="display: none;">
          <h3>顯示狀態控制</h3>
          <div class="control-group">
            <label>mode</label>
            <input type="text" id="display-mode" placeholder="collage / iframe / slide" />
          </div>
          <div class="control-group">
            <label>params JSON</label>
            <textarea id="display-params" placeholder='{"images": ["img_001.png"]}'></textarea>
          </div>
          <div class="button-group">
            <button class="primary" id="apply-display-state">套用顯示狀態</button>
            <button id="load-display-state">讀取目前狀態</button>
          </div>
        </section>

        <!-- 目前狀態顯示 -->
        <section>
          <h3>目前狀態</h3>
          <div class="status-display" id="current-state">尚未讀取...</div>
        </section>

        <!-- 其他功能 -->
        <section>
          <h3>其他功能</h3>
          <div class="button-group">
            <button id="load-layout">讀取容器佈局</button>
            <button id="clear-display-state">清除顯示狀態</button>
          </div>
        </section>
      </div>

      <!-- 事件日誌 -->
      <section style="grid-column: 1 / -1; margin-top: 24px;">
        <h3>即時事件日誌（WebSocket）</h3>
        <div class="event-log" id="event-log"></div>
      </section>
    </main>

    <script>
      const apiBase = window.location.origin;
      let currentClientId = null;
      let autoRefreshTimer = null;

      function logEvent(message, type = "info") {
        const logEl = document.getElementById("event-log");
        const stamp = new Date().toISOString();
        const line = `[${stamp}] (${type}) ${message}`;
        logEl.textContent = `${line}\n${logEl.textContent}`.slice(0, 10000);
      }

      async function requestJSON(url, options = {}) {
        const response = await fetch(url, {
          headers: { "Content-Type": "application/json" },
          ...options,
        });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`${response.status} ${response.statusText}: ${errorText}`);
        }
        if (response.status === 204) {
          return null;
        }
        return response.json();
      }

      function parseJSON(text, fallback) {
        if (!text) return fallback;
        try {
          return JSON.parse(text);
        } catch (err) {
          throw new Error("JSON 解析失敗: " + err.message);
        }
      }

      // 載入 Client 列表
      async function loadClientList() {
        try {
          const data = await fetch(`${apiBase}/api/clients`).then((res) => res.json());
          const container = document.getElementById("client-list-view");
          
          if (!data.clients || data.clients.length === 0) {
            container.innerHTML = '<div class="empty-state">目前沒有連線的客戶端</div>';
            return;
          }

          container.innerHTML = data.clients
            .map(
              (client) => `
            <div class="client-card" data-client-id="${client.client_id || ""}">
              <h3>${client.client_id || "<全域>"}</h3>
              <div class="client-meta">
                <span><span class="client-status"></span>連線中</span>
                <span>連線數: ${client.connections}</span>
                <span>能力: ${(client.capabilities || []).join(", ") || "無"}</span>
                <span>最後心跳: ${client.last_heartbeat || "-"}</span>
              </div>
            </div>
          `,
            )
            .join("");

          // 綁定點擊事件
          container.querySelectorAll(".client-card").forEach((card) => {
            card.addEventListener("click", () => {
              const clientId = card.dataset.clientId || null;
              showClientDetail(clientId);
            });
          });
        } catch (err) {
          logEvent(`載入 clients 失敗: ${err.message}`, "error");
          document.getElementById("client-list-view").innerHTML = `<div class="empty-state">載入失敗: ${err.message}</div>`;
        }
      }

      // 顯示 Client 詳細頁面
      async function showClientDetail(clientId) {
        currentClientId = clientId;
        document.getElementById("client-list-view").style.display = "none";
        document.getElementById("client-detail-view").classList.add("active");
        document.getElementById("back-btn").classList.add("visible");

        // 載入 client 資訊
        try {
          const data = await fetch(`${apiBase}/api/clients`).then((res) => res.json());
          const client = data.clients.find((c) => (c.client_id || null) === clientId) || {};
          
          document.getElementById("detail-client-name").textContent = clientId || "<全域>";
          document.getElementById("detail-connections").textContent = client.connections || 0;
          document.getElementById("detail-capabilities").textContent = (client.capabilities || []).join(", ") || "無";
          document.getElementById("detail-heartbeat").textContent = client.last_heartbeat || "-";
        } catch (err) {
          logEvent(`載入 client 資訊失敗: ${err.message}`, "error");
        }

        // 載入顯示狀態
        await loadDisplayState();
      }

      // 返回列表
      function showClientList() {
        currentClientId = null;
        document.getElementById("client-list-view").style.display = "grid";
        document.getElementById("client-detail-view").classList.remove("active");
        document.getElementById("back-btn").classList.remove("visible");
      }

      // 載入顯示狀態
      async function loadDisplayState() {
        try {
          const url = currentClientId
            ? `${apiBase}/api/clients/${encodeURIComponent(currentClientId)}/display`
            : `${apiBase}/api/display`;
          const result = await fetch(url).then((res) => res.json());
          
          document.getElementById("current-state").textContent = JSON.stringify(result, null, 2);
          
          // 根據 mode 顯示對應的控制項
          const mode = result.state?.mode;
          if (mode === "collage") {
            showCollageControls(result.state.params || {});
          } else if (mode === "iframe") {
            await loadIframeConfig();
          } else {
            showOtherControls(result.state);
          }

          // 更新模式選擇按鈕
          document.querySelectorAll(".mode-btn").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.mode === (mode || "default"));
          });

          logEvent(`讀取 ${currentClientId || "<全域>"} display_state`);
        } catch (err) {
          logEvent(`讀取 display_state 失敗: ${err.message}`, "error");
          document.getElementById("current-state").textContent = `錯誤: ${err.message}`;
        }
      }

      // 顯示 Collage 控制項
      function showCollageControls(params) {
        document.getElementById("collage-controls").style.display = "block";
        document.getElementById("other-controls").style.display = "none";

        // 設定值
        if (params.images) {
          const images = Array.isArray(params.images) ? params.images : [];
          document.getElementById("collage-images").value = images.join(", ");
          updateImageList(images);
        }

        document.getElementById("collage-rows").value = params.rows || 3;
        document.getElementById("collage-rows-num").value = params.rows || 3;
        document.getElementById("collage-cols").value = params.cols || 3;
        document.getElementById("collage-cols-num").value = params.cols || 3;
        document.getElementById("collage-mix").checked = params.mix || false;
      }

      // 顯示 Iframe 控制項
      function showIframeControls(config) {
        document.getElementById("collage-controls").style.display = "none";
        document.getElementById("iframe-controls").style.display = "block";
        document.getElementById("other-controls").style.display = "none";

        if (config) {
          document.getElementById("iframe-layout").value = config.layout || "grid";
          document.getElementById("iframe-gap").value = config.gap ?? 12;
          document.getElementById("iframe-gap-num").value = config.gap ?? 12;
          document.getElementById("iframe-columns").value = config.columns ?? 2;
          document.getElementById("iframe-columns-num").value = config.columns ?? 2;
          
          // 更新欄數顯示（僅 grid 模式顯示）
          updateIframeColumnsVisibility();
          
          // 顯示面板列表
          renderIframePanels(config.panels || []);
        } else {
          renderIframePanels([]);
        }
      }

      // 更新欄數顯示
      function updateIframeColumnsVisibility() {
        const layout = document.getElementById("iframe-layout").value;
        const columnsGroup = document.getElementById("iframe-columns-group");
        columnsGroup.style.display = layout === "grid" ? "block" : "none";
        // 重新渲染面板列表以顯示/隱藏 col_span 和 row_span
        renderIframePanels(currentPanelsData);
      }

      // 渲染面板列表
      let currentPanelsData = [];
      function renderIframePanels(panels) {
        currentPanelsData = panels || [];
        const container = document.getElementById("iframe-panels-list");
        const layout = document.getElementById("iframe-layout").value;
        
        if (!panels || panels.length === 0) {
          container.innerHTML = '<div style="opacity: 0.6; padding: 12px;">尚無面板，點擊「+ 新增面板」來添加</div>';
          return;
        }
        
        container.innerHTML = panels.map((panel, index) => {
          const panelId = panel.id || `panel_${index + 1}`;
          return `
            <div class="control-group" style="border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong>面板 ${index + 1}: ${panelId}</strong>
                <button type="button" class="remove-panel-btn" data-index="${index}" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.5);">刪除</button>
              </div>
              <div class="control-group">
                <label>ID</label>
                <input type="text" class="panel-id" data-index="${index}" value="${panelId}" placeholder="panel_1" />
              </div>
              <div class="control-group">
                <label>圖像檔名 (image)</label>
                <input type="text" class="panel-image" data-index="${index}" value="${panel.image || ""}" placeholder="offspring_xxx.png" />
              </div>
              <div class="control-group">
                <label>或直接 URL (url)</label>
                <input type="text" class="panel-url" data-index="${index}" value="${panel.url || ""}" placeholder="https://example.com" />
              </div>
              <div class="control-group">
                <label>標籤 (label)</label>
                <input type="text" class="panel-label" data-index="${index}" value="${panel.label || ""}" placeholder="面板標籤" />
              </div>
              <div class="control-group">
                <label>比例 (ratio)</label>
                <input type="number" class="panel-ratio" data-index="${index}" value="${panel.ratio || 1}" min="0.1" step="0.1" />
              </div>
              ${layout === "grid" ? `
              <div class="control-group">
                <label>欄跨度 (col_span)</label>
                <input type="number" class="panel-col-span" data-index="${index}" value="${panel.col_span || panel.colSpan || ""}" min="1" placeholder="1" />
              </div>
              <div class="control-group">
                <label>列跨度 (row_span)</label>
                <input type="number" class="panel-row-span" data-index="${index}" value="${panel.row_span || panel.rowSpan || ""}" min="1" placeholder="1" />
              </div>
              ` : ""}
              <div class="control-group">
                <label>參數 (params JSON)</label>
                <textarea class="panel-params" data-index="${index}" placeholder='{"slide_mode": "true"}' style="min-height: 60px;">${JSON.stringify(panel.params || {}, null, 2)}</textarea>
              </div>
            </div>
          `;
        }).join("");
        
        // 綁定刪除按鈕
        container.querySelectorAll(".remove-panel-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const index = parseInt(btn.dataset.index);
            currentPanelsData.splice(index, 1);
            renderIframePanels(currentPanelsData);
          });
        });
      }

      // 載入 Iframe 配置
      async function loadIframeConfig() {
        try {
          let url = `${apiBase}/api/iframe-config`;
          if (currentClientId) {
            url += `?client=${encodeURIComponent(currentClientId)}`;
          }
          const result = await fetch(url).then((res) => res.json());
          
          // result 可能是 resolved config，需要從 raw 取得原始配置
          const config = result.raw || result;
          showIframeControls(config);
          
          logEvent(`讀取 ${currentClientId || "<全域>"} iframe_config`);
        } catch (err) {
          logEvent(`讀取 iframe_config 失敗: ${err.message}`, "error");
          showIframeControls(null);
        }
      }

      // 套用 Iframe 配置
      async function applyIframe() {
        const layout = document.getElementById("iframe-layout").value;
        const gap = Number(document.getElementById("iframe-gap").value);
        const columns = Number(document.getElementById("iframe-columns").value);
        
        // 收集所有面板
        const panels = [];
        const panelElements = document.querySelectorAll('.panel-id');
        panelElements.forEach((idInput, index) => {
          const panelId = idInput.value.trim() || `panel_${index + 1}`;
          const imageInput = document.querySelector(`.panel-image[data-index="${index}"]`);
          const urlInput = document.querySelector(`.panel-url[data-index="${index}"]`);
          const labelInput = document.querySelector(`.panel-label[data-index="${index}"]`);
          const ratioInput = document.querySelector(`.panel-ratio[data-index="${index}"]`);
          const colSpanInput = document.querySelector(`.panel-col-span[data-index="${index}"]`);
          const rowSpanInput = document.querySelector(`.panel-row-span[data-index="${index}"]`);
          const paramsInput = document.querySelector(`.panel-params[data-index="${index}"]`);
          
          const image = imageInput?.value.trim() || null;
          const url = urlInput?.value.trim() || null;
          const label = labelInput?.value.trim() || null;
          const ratio = ratioInput?.value ? Number(ratioInput.value) : 1;
          const colSpan = colSpanInput?.value ? Number(colSpanInput.value) : undefined;
          const rowSpan = rowSpanInput?.value ? Number(rowSpanInput.value) : undefined;
          
          let params = {};
          try {
            if (paramsInput?.value.trim()) {
              params = JSON.parse(paramsInput.value);
            }
          } catch (e) {
            alert(`面板 ${index + 1} 的 params JSON 格式錯誤: ${e.message}`);
            return;
          }
          
          if (!image && !url) {
            return; // 跳過沒有 image 或 url 的面板
          }
          
          const panel = {
            id: panelId,
            ratio: ratio,
          };
          if (image) panel.image = image;
          if (url) panel.url = url;
          if (label) panel.label = label;
          if (Object.keys(params).length > 0) panel.params = params;
          if (layout === "grid") {
            if (colSpan) panel.col_span = colSpan;
            if (rowSpan) panel.row_span = rowSpan;
          }
          
          panels.push(panel);
        });
        
        if (panels.length === 0) {
          alert("請至少添加一個面板（需有 image 或 url）");
          return;
        }
        
        const payload = {
          layout,
          gap,
          columns,
          panels,
        };
        
        if (currentClientId) {
          payload.target_client_id = currentClientId;
        }
        
        try {
          // 先設定 display_state 為 iframe 模式
          const displayUrl = currentClientId
            ? `${apiBase}/api/clients/${encodeURIComponent(currentClientId)}/display`
            : `${apiBase}/api/display`;
          await requestJSON(displayUrl, {
            method: "POST",
            body: JSON.stringify({ mode: "iframe", params: {} }),
          });
          
          // 再設定 iframe 配置
          const result = await requestJSON(`${apiBase}/api/iframe-config`, {
            method: "PUT",
            body: JSON.stringify(payload),
          });
          
          logEvent(`套用 iframe 至 ${currentClientId || "<全域>"}`);
          await loadIframeConfig();
          await loadDisplayState();
        } catch (err) {
          alert(err.message);
          logEvent(`Iframe 設定失敗: ${err.message}`, "error");
        }
      }

      // 顯示其他模式控制項
      function showOtherControls(state) {
        document.getElementById("collage-controls").style.display = "none";
        document.getElementById("iframe-controls").style.display = "none";
        document.getElementById("other-controls").style.display = "block";

        if (state) {
          document.getElementById("display-mode").value = state.mode || "";
          document.getElementById("display-params").value = JSON.stringify(state.params || {}, null, 2);
        }
      }

      // 更新圖像列表顯示
      function updateImageList(images) {
        const container = document.getElementById("collage-image-list");
        if (!images || images.length === 0) {
          container.innerHTML = "";
          return;
        }
        container.innerHTML = images.map((img) => `<div class="image-item">${img}</div>`).join("");
      }

      // 同步 slider 和 number input
      function syncSliderNumber(sliderId, numberId) {
        const slider = document.getElementById(sliderId);
        const number = document.getElementById(numberId);
        slider.addEventListener("input", () => {
          number.value = slider.value;
        });
        number.addEventListener("input", () => {
          slider.value = number.value;
        });
      }

      // 套用 Collage
      async function applyCollage() {
        const images = document.getElementById("collage-images").value
          .split(",")
          .map((item) => item.trim())
          .filter(Boolean);
        
        const payload = {
          images,
          rows: Number(document.getElementById("collage-rows").value),
          cols: Number(document.getElementById("collage-cols").value),
          mix: document.getElementById("collage-mix").checked,
        };

        try {
          const result = currentClientId
            ? await requestJSON(
                `${apiBase}/api/clients/${encodeURIComponent(currentClientId)}/collage`,
                {
                  method: "POST",
                  body: JSON.stringify(payload),
                },
              )
            : await requestJSON(`${apiBase}/api/display`, {
                method: "POST",
                body: JSON.stringify({ mode: "collage", params: payload }),
              });
          document.getElementById("current-state").textContent = JSON.stringify(result, null, 2);
          logEvent(`套用 collage 至 ${currentClientId}`);
          await loadDisplayState();
        } catch (err) {
          alert(err.message);
          logEvent(`Collage 設定失敗: ${err.message}`, "error");
        }
      }

      // 重新打散
      async function shuffleCollage() {
        const payload = {
          images: document.getElementById("collage-images").value
            .split(",")
            .map((item) => item.trim())
            .filter(Boolean),
          rows: Number(document.getElementById("collage-rows").value),
          cols: Number(document.getElementById("collage-cols").value),
          mix: document.getElementById("collage-mix").checked,
          shuffle_seed: Date.now(),
        };

        try {
          const result = currentClientId
            ? await requestJSON(
                `${apiBase}/api/clients/${encodeURIComponent(currentClientId)}/collage`,
                {
                  method: "POST",
                  body: JSON.stringify(payload),
                },
              )
            : await requestJSON(`${apiBase}/api/display`, {
                method: "POST",
                body: JSON.stringify({ mode: "collage", params: payload }),
              });
          document.getElementById("current-state").textContent = JSON.stringify(result, null, 2);
          logEvent(`重新打散 collage (${currentClientId})`);
          await loadDisplayState();
        } catch (err) {
          alert(err.message);
          logEvent(`重新打散失敗: ${err.message}`, "error");
        }
      }

      // WebSocket 連線
      function setupWebSocket() {
        const base = apiBase.replace(/^http/, "ws");
        const socket = new WebSocket(`${base}/ws/screenshots`);
        socket.addEventListener("open", () => {
          socket.send(
            JSON.stringify({
              type: "hello",
              client_id: "admin_console",
              capabilities: ["controller"],
            }),
          );
          logEvent("WebSocket 已連線", "ws");
        });
        socket.addEventListener("message", (event) => {
          logEvent(event.data, "event");
        });
        socket.addEventListener("close", () => {
          logEvent("WebSocket 已關閉，2 秒後重連", "ws");
          setTimeout(setupWebSocket, 2000);
        });
        socket.addEventListener("error", (err) => {
          logEvent(`WebSocket 發生錯誤: ${err.message}`, "error");
        });
      }

      // 事件綁定
      document.getElementById("back-btn").addEventListener("click", showClientList);

      document.querySelectorAll(".mode-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".mode-btn").forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          
          const mode = btn.dataset.mode;
          if (mode === "collage") {
            showCollageControls({});
          } else if (mode === "iframe") {
            loadIframeConfig();
          } else if (mode === "default") {
            showOtherControls(null);
          } else {
            showOtherControls({ mode });
          }
        });
      });

      syncSliderNumber("collage-rows", "collage-rows-num");
      syncSliderNumber("collage-cols", "collage-cols-num");
      syncSliderNumber("collage-image-count", "collage-image-count-num");
      syncSliderNumber("iframe-gap", "iframe-gap-num");
      syncSliderNumber("iframe-columns", "iframe-columns-num");

      document.getElementById("collage-images").addEventListener("input", (e) => {
        const images = e.target.value.split(",").map((item) => item.trim()).filter(Boolean);
        updateImageList(images);
      });

      document.getElementById("iframe-layout").addEventListener("change", updateIframeColumnsVisibility);

      document.getElementById("add-iframe-panel").addEventListener("click", () => {
        const newPanel = {
          id: `panel_${currentPanelsData.length + 1}`,
          image: "",
          url: "",
          label: "",
          ratio: 1,
          params: {},
        };
        currentPanelsData.push(newPanel);
        renderIframePanels(currentPanelsData);
      });

      document.getElementById("apply-collage").addEventListener("click", applyCollage);
      document.getElementById("shuffle-collage").addEventListener("click", shuffleCollage);
      document.getElementById("apply-iframe").addEventListener("click", applyIframe);
      document.getElementById("load-iframe-config").addEventListener("click", loadIframeConfig);
      document.getElementById("load-display-state").addEventListener("click", loadDisplayState);
      document.getElementById("clear-display-state").addEventListener("click", async () => {
        try {
          const url = currentClientId
            ? `${apiBase}/api/clients/${encodeURIComponent(currentClientId)}/display`
            : `${apiBase}/api/display`;
          await fetch(url, { method: "DELETE" });
          logEvent(`清除 ${currentClientId} display_state`);
          await loadDisplayState();
        } catch (err) {
          alert(err.message);
          logEvent(`清除失敗: ${err.message}`, "error");
        }
      });

      // 初始化
      loadClientList();
      setupWebSocket();

      // 自動刷新列表
      setInterval(loadClientList, 5000);
    </script>
  </body>
</html>
