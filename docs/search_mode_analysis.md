# å‰ç«¯ Search Mode å®Œæ•´åˆ†æ

## ğŸ” ç¸½é«”æ¶æ§‹

### 1. æ ¸å¿ƒæµç¨‹

```
URL (?search_mode=true) 
  â†“
App.jsx è®€å–åƒæ•¸
  â†“
searchMode = true
  â†“
æ¸²æŸ“ SearchMode å…ƒä»¶
  â†“
éš±è— KinshipSceneï¼Œé¡¯ç¤ºæœå°‹ç•Œé¢
```

### 2. App.jsx ä¸­çš„è§¸ç™¼é‚è¼¯

```javascript
// ç¬¬ 46 è¡Œ
const searchMode = !incubatorMode && !phylogenyMode && 
  (readParams().get("search_mode") ?? "false") === "true";

// ç¬¬ 469-471 è¡Œ
if (searchMode) {
  return <SearchMode imagesBase={IMAGES_BASE} />;
}
```

**é—œéµé»ï¼š**
- searchMode æ˜¯ä¸‰å€‹äº’æ–¥æ¨¡å¼ä¹‹ä¸€ï¼ˆincubator | phylogeny | searchï¼‰
- åªéœ€åœ¨ URL æ·»åŠ  `?search_mode=true` å³å¯æ¿€æ´»
- æœƒå®Œå…¨æ›¿æ› KinshipSceneï¼Œä¸é¡¯ç¤º 3D è¦–æ™¯

---

## ğŸ¨ SearchMode å…ƒä»¶è©³è§£

### 1. ç‹€æ…‹ç®¡ç†

#### æœå°‹æ¨¡å¼åˆ‡æ›
```javascript
const [searchType, setSearchType] = useState("image"); // "image" | "text"
```

#### ä»¥åœ–æœåœ–ç‹€æ…‹
```javascript
const [selectedFile, setSelectedFile] = useState(null);      // é¸ä¸­çš„æª”æ¡ˆ
const [preview, setPreview] = useState(null);                // Base64 é è¦½
const fileInputRef = useRef(null);                           // Input å¼•ç”¨
```

#### æ–‡å­—æœå°‹ç‹€æ…‹
```javascript
const [textQuery, setTextQuery] = useState("");               // æœå°‹è©
```

#### å…±åŒç‹€æ…‹
```javascript
const [searching, setSearching] = useState(false);            // æœå°‹ä¸­æ¨™èªŒ
const [results, setResults] = useState([]);                   // æœå°‹çµæœ
const [error, setError] = useState(null);                     // éŒ¯èª¤ä¿¡æ¯
```

### 2. ä»¥åœ–æœåœ–æµç¨‹

```
1ï¸âƒ£  ç”¨æˆ¶ä¸Šå‚³åœ–ç‰‡
    â†“
    handleFileSelect()
    - è¨­ç½® selectedFile
    - ç”Ÿæˆ Base64 previewï¼ˆç”¨æ–¼é è¦½ï¼‰
    â†“

2ï¸âƒ£  ç”¨æˆ¶é»æ“Šã€Œæœå°‹ã€
    â†“
    handleImageSearch()
    - POST åœ–ç‰‡åˆ° /api/screenshots
    - å¾Œå°è¿”å› absolute_path
    - èª¿ç”¨ searchImagesByImage(path, topK=15)
    - å¾Œå°æœå°‹ç›¸ä¼¼åœ–åƒ
    â†“

3ï¸âƒ£  çµæœé¡¯ç¤º
    - results åˆ—è¡¨æ›´æ–°
    - ç¶²æ ¼é¡¯ç¤ºå¡ç‰‡
```

**é—œéµä»£ç¢¼ï¼ˆç¬¬ 49-79 è¡Œï¼‰ï¼š**
```javascript
const uploadRes = await fetch(`${apiBase}/api/screenshots`, {
  method: "POST",
  body: formData,
});
const uploadData = await uploadRes.json();
const uploadedPath = uploadData.absolute_path || uploadData.relative_path;

const searchResults = await searchImagesByImage(uploadedPath, 15);
```

### 3. æ–‡å­—æœå°‹æµç¨‹

```
1ï¸âƒ£  ç”¨æˆ¶è¼¸å…¥æ–‡å­—
    â†“
    setTextQuery(value)
    â†“

2ï¸âƒ£  ç”¨æˆ¶æŒ‰ã€ŒEnterã€æˆ–é»æ“Šã€Œæœå°‹ã€
    â†“
    handleTextSearch()
    - é©—è­‰ textQuery éç©º
    - èª¿ç”¨ searchImagesByText(query, topK=15)
    - å¾Œå°æœå°‹ç›¸é—œåœ–åƒ
    â†“

3ï¸âƒ£  çµæœé¡¯ç¤º
    - results åˆ—è¡¨æ›´æ–°
    - ç¶²æ ¼é¡¯ç¤ºå¡ç‰‡
```

**é—œéµä»£ç¢¼ï¼ˆç¬¬ 107-119 è¡Œï¼‰ï¼š**
```javascript
const searchResults = await searchImagesByText(textQuery, 15);
const resultList = searchResults.results || [];
setResults(resultList);
```

### 4. UI çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” ç›¸ä¼¼åº¦æœå°‹                          â”‚
â”‚  ä»¥åœ–ç‰‡æˆ–æ–‡å­—æœå°‹ç›¸ä¼¼çš„å¾Œä»£å½±åƒ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ¨¡å¼åˆ‡æ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ğŸ“¸ ä»¥åœ–æœåœ–]  [ğŸ“ æ–‡å­—æœå°‹]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æœå°‹å€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  (ä¾æ¨¡å¼å‹•æ…‹é¡¯ç¤º)                       â”‚
â”‚                                         â”‚
â”‚  ä»¥åœ–æœåœ–:                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  ğŸ“¸ é»æ“Šä¸Šå‚³åœ–ç‰‡æˆ–æ‹–æ”¾      â”‚       â”‚
â”‚  â”‚  æ”¯æ´ PNG, JPG, JPEG        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  [ğŸš€ æœå°‹] [æ¸…é™¤]                      â”‚
â”‚                                         â”‚
â”‚  æ–‡å­—æœå°‹:                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ è¼¸å…¥æœå°‹è©... ä¾‹å¦‚ï¼šç™½é¦¬     â”‚ (å¯Enter)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  [ğŸš€ æœå°‹] [æ¸…é™¤]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ éŒ¯èª¤å€ï¼ˆæ¢ä»¶é¡¯ç¤ºï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ éŒ¯èª¤ä¿¡æ¯                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ çµæœå€ï¼ˆæ¢ä»¶é¡¯ç¤ºï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœå°‹çµæœï¼ˆN å¼µï¼‰                       â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ åœ–1  â”‚  â”‚ åœ–2  â”‚  â”‚ åœ–3  â”‚         â”‚
â”‚  â”‚ è·é›¢ â”‚  â”‚ è·é›¢ â”‚  â”‚ è·é›¢ â”‚         â”‚
â”‚  â”‚åç¨±  â”‚  â”‚åç¨±  â”‚  â”‚åç¨±  â”‚         â”‚
â”‚  â”‚ç›¸ä¼¼åº¦â”‚  â”‚ç›¸ä¼¼åº¦â”‚  â”‚ç›¸ä¼¼åº¦â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¡ API å‘¼å«

### ç›¸é—œ API ç«¯é»

| æ“ä½œ | ç«¯é» | æ–¹æ³• | ä¾†æº |
|------|------|------|------|
| ä¸Šå‚³åœ–ç‰‡ | `/api/screenshots` | POST | å¾Œå° `/api/screenshots` |
| ä»¥åœ–æœåœ– | `/api/search/image` | POST | å¾Œå° `/api/search/image` |
| æ–‡å­—æœå°‹ | `/api/search/text` | POST | å¾Œå° `/api/search/text` |

### è«‹æ±‚/å›æ‡‰æ ¼å¼

#### ä¸Šå‚³åœ–ç‰‡
```javascript
POST /api/screenshots
Content-Type: multipart/form-data

Response:
{
  absolute_path: "/path/to/uploaded/file.png",
  relative_path: "uploaded/file.png"
}
```

#### ä»¥åœ–æœåœ–
```javascript
POST /api/search/image
{
  image_path: "/path/to/image.png",
  top_k: 15
}

Response:
{
  results: [
    {
      id: "offspring_20250923_161624_066.png",
      distance: 0.4151,
      metadata: { ... }
    },
    ...
  ]
}
```

#### æ–‡å­—æœå°‹
```javascript
POST /api/search/text
{
  query: "ç™½é¦¬",
  top_k: 15
}

Response:
{
  results: [
    {
      id: "offspring_20250923_161704_451.png",
      distance: 1.3147,
      metadata: { ... }
    },
    ...
  ]
}
```

---

## ğŸ¯ ç›¸ä¼¼åº¦è¨ˆç®—

### è·é›¢ â†’ ç›¸ä¼¼åº¦ç™¾åˆ†æ¯”è½‰æ›

```javascript
// ç¬¬ 294 è¡Œ
const similarity = Math.max(0, ((1 - (distance / 2)) * 100)).toFixed(0);
```

**å…¬å¼è§£é‡‹ï¼š**
- `distance / 2` = æ­£è¦åŒ–è·é›¢ï¼ˆå‡è¨­æœ€å¤§è·é›¢ç´„ç‚º 2ï¼‰
- `1 - (distance / 2)` = ç›¸ä¼¼åº¦æ¯”ä¾‹ï¼ˆ0 åˆ° 1ï¼‰
- `* 100` = ç™¾åˆ†æ¯”
- `Math.max(0, ...)` = é˜²æ­¢è² æ•¸

**è·é›¢å°æ‡‰çš„ç›¸ä¼¼åº¦ï¼š**
| è·é›¢ | ç›¸ä¼¼åº¦ |
|------|--------|
| 0 | 100% |
| 0.5 | 75% |
| 1.0 | 50% |
| 1.5 | 25% |
| 2.0+ | â‰¤0% (æ­¸é›¶) |

---

## ğŸ”Œ å•Ÿç”¨æ–¹å¼

### è¨ªå• URL

```
åŸºç¤:
http://localhost:5173/?search_mode=true

å¸¶è‡ªè¨‚ API åŸºå€:
http://localhost:5173/?search_mode=true&api=http://localhost:8000

å¸¶è‡ªè¨‚åœ–åƒåŸºå€:
http://localhost:5173/?search_mode=true&images=/api/generated/
```

### ç’°å¢ƒè®Šæ•¸

åœ¨ `.env` æˆ– `vite.config.js` ä¸­è¨­ç½®ï¼š

```env
VITE_API_BASE=http://localhost:8000
VITE_IMAGES_BASE=/generated_images/
```

---

## âš™ï¸ æ ¸å¿ƒé‚è¼¯æµç¨‹åœ–

```
SearchMode.jsx
â”‚
â”œâ”€ åˆå§‹åŒ–ç‹€æ…‹
â”‚  â”œâ”€ searchType: "image"
â”‚  â”œâ”€ selectedFile: null
â”‚  â”œâ”€ textQuery: ""
â”‚  â”œâ”€ searching: false
â”‚  â”œâ”€ results: []
â”‚  â””â”€ error: null
â”‚
â”œâ”€ æ¸²æŸ“ UI
â”‚  â”œâ”€ header (æ¨™é¡Œ)
â”‚  â”œâ”€ modeSelector (åˆ‡æ›æŒ‰éˆ•)
â”‚  â”œâ”€ æ¢ä»¶æ¸²æŸ“æœå°‹å€
â”‚  â”‚  â”œâ”€ IF searchType === "image"
â”‚  â”‚  â”‚  â”œâ”€ uploadArea
â”‚  â”‚  â”‚  â”‚  â”œâ”€ é è¦½ï¼ˆå¦‚æœæœ‰æª”æ¡ˆï¼‰
â”‚  â”‚  â”‚  â”‚  â””â”€ ä¸Šå‚³æç¤ºï¼ˆå¦‚æœç„¡æª”æ¡ˆï¼‰
â”‚  â”‚  â”‚  â””â”€ controls (æœå°‹/æ¸…é™¤æŒ‰éˆ•)
â”‚  â”‚  â””â”€ IF searchType === "text"
â”‚  â”‚     â”œâ”€ textSearchArea
â”‚  â”‚     â”‚  â””â”€ textInput (å¯ Enter)
â”‚  â”‚     â””â”€ controls (æœå°‹/æ¸…é™¤æŒ‰éˆ•)
â”‚  â”œâ”€ errorArea (æ¢ä»¶é¡¯ç¤º)
â”‚  â””â”€ resultsGrid (æ¢ä»¶é¡¯ç¤º)
â”‚     â””â”€ å¡ç‰‡åˆ—è¡¨
â”‚
â””â”€ äº‹ä»¶è™•ç†
   â”œâ”€ æ¨¡å¼åˆ‡æ›: setSearchType()
   â”œâ”€ ä»¥åœ–æœåœ–
   â”‚  â”œâ”€ handleFileSelect(): FileReader â†’ preview
   â”‚  â”œâ”€ handleImageSearch(): ä¸Šå‚³ â†’ æœå°‹
   â”‚  â””â”€ handleClear(): æ¸…ç©ºç‹€æ…‹
   â””â”€ æ–‡å­—æœå°‹
      â”œâ”€ handleTextSearch(): ç›´æ¥æœå°‹
      â”œâ”€ handleKeyPress(): Enter è§¸ç™¼
      â””â”€ handleTextClear(): æ¸…ç©ºç‹€æ…‹
```

---

## ğŸ› å¯èƒ½çš„æ”¹é€²

1. **æ‹–æ”¾ä¸Šå‚³** - ç›®å‰åªæ”¯æ´é»æ“Šï¼Œå¯æ·»åŠ æ‹–æ”¾äº‹ä»¶
2. **æ‰¹é‡æœå°‹** - å¯æ”¯æ´å¤šåœ–åŒæ™‚æœå°‹
3. **æœå°‹æ­·å²** - ä¿å­˜æœå°‹è¨˜éŒ„
4. **çµæœç¯©é¸** - æŒ‰ç›¸ä¼¼åº¦ã€æ™‚é–“ç¯©é¸
5. **å…¨è¢å¹•é è¦½** - çµæœå¡ç‰‡å¯é»æ“Šæ”¾å¤§

---

## ğŸ“ æ–‡ä»¶ä½ç½®åƒè€ƒ

- **å‰ç«¯æœå°‹å…ƒä»¶**: `frontend/src/SearchMode.jsx` (492 è¡Œ)
- **ä¸»æ‡‰ç”¨ç¨‹å¼**: `frontend/src/App.jsx` (ç¬¬ 46, 469-471 è¡Œ)
- **API åŒ…è£**: `frontend/src/api.js`
- **å¾Œç«¯æœå°‹ API**:
  - `backend/app/main.py` - ç«¯é»å®šç¾©
  - `backend/app/services/vector_store.py` - æœå°‹é‚è¼¯
  - `backend/app/utils/embeddings.py` - OpenAI åµŒå…¥

