# 前端架構概論（Frontend Architecture Overview）

> 狀態: 與現況程式碼同步  
> 最後更新: 2025-11-04

---

## 1. 概述與技術棧

- 基礎: React 18 + Vite 5（開發/建置）
- 3D 與動畫:
  - three 0.160.0
  - @react-three/fiber 8.15.19（R3F）
  - @react-three/drei 9.105.6（Three.js helpers）
  - @react-spring/web / @react-spring/three（動畫）
- 環境變數（Vite）：
  - `VITE_API_BASE`（後端 API Base，如空則相對 `/api` 路徑）
  - `VITE_IMAGES_BASE`（影像靜態基底，預設 `/generated_images/`）
- 主要互動對象：`backend/app/main.py` 所提供之 API 與 WebSocket `/ws/screenshots`

---

## 2. 目錄與關鍵檔案

- `frontend/src/App.jsx`：入口與模式切換，負責組合各模式元件與 hooks
- 模式元件（七種視覺化模式）
  - `frontend/src/ThreeKinshipScene.jsx`：
    - SceneContent（預設 3D 景觀）
    - PhylogenySceneContent（2D 親緣圖）
    - IncubatorSceneContent（孵化室）
  - `frontend/src/OrganicRoomScene.jsx`：有機房間模式（自動尋找 6 張相似圖）
  - `frontend/src/SlideMode.jsx`：幻燈片模式（向量或親緣來源）
  - `frontend/src/SearchMode.jsx`：搜尋模式（以圖/文字）
  - `frontend/src/IframeMode.jsx`：Iframe 組合顯示
- 系統元件
  - `frontend/src/SoundPlayer.jsx`：透過 WS 接收 `sound_play` 訊息自動播放音效
  - `frontend/src/api.js`：封裝 API 呼叫（搜尋、親緣、上傳等）
  - `frontend/src/styles.css`：全域樣式
- 協作用共用模組
  - `frontend/src/hooks/`：跨模式共用的 React hooks（見 §5）
  - `frontend/src/utils/iframeConfig.js`：Iframe 設定解析/正規化工具

---

## 3. 模式切換與 URL 參數

- 由 `App.jsx` 解析 URL 查詢參數決定要渲染哪個模式，核心參數：
  - `img=offspring_xxx.png`：錨點影像（多數模式需要）
  - `phylogeny=true`：2D 親緣圖
  - `incubator=true`：孵化室
  - `organic_mode=true`：有機房間
  - `slide_mode=true`：幻燈片
  - `search_mode=true`：搜尋
  - `iframe_mode=true`：Iframe 組合
  - 其他：
    - `slide_source=vector|kinship`（SlideMode 資料來源）
- 影像 Base：`IMAGES_BASE = import.meta.env.VITE_IMAGES_BASE || "/generated_images/"`
  - 前端各模式以「檔名」拼接為完整 URL：`imagesBase + filename`

---

## 4. 主要元件詳解

> `App.jsx` 目前只處理「URL → 模式判斷 → 對應元件渲染」。其餘如字幕、截圖、iframe 配置、WebSocket 都委派給 hooks（§5）。

### 4.1 ThreeKinshipScene.jsx
- 內含三個場景內容：
  - SceneContent（預設 3D 景觀）
    - 特色：ClusterFlower 叢集布局；中心 + 父母/子代/兄弟/祖先環狀排列；叢集可獨立旋轉/浮動；react-spring 漸入
    - 參數：`autoplay`（預設開）、`step`（預設 30 秒）、`continuous`
    - 視角：FOV 55；初始相機 (0, 1.2, 15)；OrbitControls 距離 4–60
  - PhylogenySceneContent（2D 親緣圖）
    - 特色：樹狀水平分層；Billboard 節點；外框依節點類型上色
    - 布局常數：`PHYLO_LEVEL_GAP` 7.5；`PHYLO_NODE_SPACING` 6.2；`PHYLO_NODE_BASE_SIZE` 3.4
    - 自動相機距離以節點分布計算，確保完整視野
  - IncubatorSceneContent（孵化室）
    - 特色：中心/上環（父）/下環（子）/外環（兄弟/祖先）；96 粒子霧氣（IncubatorMist）；彩色 Flow Overlay；分組漸進動畫
    - 布局常數：最多 60 節點；`INCUBATOR_BASE_RADIUS` 4.4；`INCUBATOR_RADIUS_STEP` 3.3；`INCUBATOR_LEVEL_GAP` 4.6
    - 視角：FOV 52；初始 (0, 2.4, 24)；OrbitControls 距離 6–48

### 4.2 OrganicRoomScene.jsx
- 立方體房間（六面六圖），自動從錨點影像使用向量搜尋取回 6 張相似圖填滿
- OrganicCruise（有機巡航）：相機在房間飄移；每 ~24 秒靠近一面並將其圖像設為新錨點 → 觸發下一輪搜尋
- 立方體可緩慢自轉（`showInfo` 會停用動畫）
- 參數：房間邊長 12；相機初始 (0,0,4.6)、FOV 58；OrbitControls 距離 2.5–8、target=(0,-1.2,0)

### 4.3 SlideMode.jsx
- 單圖全螢幕輪播；來源：
  - `slide_source=vector`（預設）：向量相似度搜尋
  - `slide_source=kinship`：親緣路徑（children → siblings → parents → ancestors）
- 固定批次：`BATCH_SIZE=15`；顯示次序會先依 `DISPLAY_ORDER` 撿取再補齊
- 使用 `searchImagesByImage()` 與 `fetchKinship()`（from `api.js`）
- `cleanId()` 會剔除 `:en|:zh` 後綴，以檔名作為顯示與載入鍵值
- 互動：
  - `Ctrl+R` 顯示/隱藏檔名、進度與速度控制條
  - 速度 0.5x–10x；可暫停/播放
- 邏輯：播放到清單尾端後，以最後一張作為 anchor 再次搜尋（無限巡迴）

### 4.4 SearchMode.jsx
- 兩種搜尋：
  - 以圖搜圖：上傳檔案 → `POST /api/screenshots` → 使用回傳的 `original_filename` 嘗試快速路徑 `backend/offspring_images/<original>` 查詢；失敗再以實際路徑回退
  - 文字搜尋：`POST /api/search/text`
- 結果網格顯示：縮圖、距離（distance）；點擊結果以該圖再次搜尋（以 `backend/offspring_images/<cleanId>` ）
- 共通狀態：`searching`/`results`/`error`；基本錯誤提示與 UI 控制列

### 4.5 IframeMode.jsx
- 多面板組合顯示，佈局 `grid|horizontal|vertical`，最多 12 面板
- 面板欄位：`src|label|ratio|image|params|url`；可由 URL 參數或後端 `GET /api/iframe-config` 提供
- WebSocket 可即時接收後端推送的配置更新（`type: iframe_config`）
- 本地配置模式：`Ctrl+R` 開關控制面板；套用後更新 URL 參數

### 4.6 SoundPlayer.jsx
- 監聽 WebSocket `/ws/screenshots`，接收：
  - `sound_play`（播放指定檔名/URL 的音效）
  - `sound_effect_ready`（音效生成完成事件，可選）
- 以 `<audio>` 串流播放 `GET /api/sound-files/<filename>` 的內容

### 4.7 api.js
- 包裝常用 API：
  - 向量搜尋：`POST /api/search/image`, `POST /api/search/text`
  - 親緣圖：`GET /api/kinship?img=...&depth=...`
  - 截圖上傳：`POST /api/screenshots`（回傳 `original_filename`, `absolute_path` 等）
- 以 `VITE_API_BASE` 作為 Base URL，未指定時走相對路徑

---

## 5. 共用 Hooks 與工具（2025-11 版）

為了讓 `App.jsx` 保持精簡、便於協作，以下功能已抽象成 hooks：

- `useSubtitleCaption(clientId)` — `frontend/src/hooks/useSubtitleCaption.js`
  - 初始載入 `fetchSubtitleState` / `fetchCaptionState`
  - 正規化文字、語言、有效期間
  - 依 `duration_seconds` 或 `expires_at` 自動清除，避免計時器散落於各元件
  - 回傳 `{ subtitle, caption, applySubtitle, applyCaption }`

- `useScreenshotManager(clientId)` — `frontend/src/hooks/useScreenshotManager.js`
  - 管理 WebSocket 佇列、重入鎖、計時器與訊息提示
  - 將 `window.__APP_CAPTURE_SCENE` 的註冊/清理與 screenshot API 上傳集中在一處
  - 對外提供
    - `handleCaptureReady(fn)`：子元件（`IframeMode`, `SlideMode`, `ThreeKinshipScene`）在就緒時註冊截圖函式
    - `enqueueScreenshotRequest(payload)`：接收 WS `screenshot_request`
    - `markRequestDone(requestId)`：當 `screenshot_completed|failed` 時解除鎖定
    - `screenshotMessage`：給 UI 顯示狀態用

- `useIframeConfig({ initialParams, iframeMode, clientId, defaultConfig })` — `frontend/src/hooks/useIframeConfig.js`
  - 解析 URL 參數 → `sanitize` 成可用的面板設定
  - 根據 `iframeMode` 控制遠端載入與本地 fallback
  - 中央化 URL 同步邏輯（當 `PERSIST_IFRAME_QUERY=true` 時才寫回）
  - 回傳 `{ iframeActiveConfig, iframeControlsEnabled, handleLocalIframeConfigApply, applyRemoteIframeConfig }`

- `useControlSocket(options)` — `frontend/src/hooks/useControlSocket.js`
  - 管理 WebSocket `/ws/screenshots`
  - 內建重連機制（簡單的 2 秒重試）
  - 依 `payload.type` 將事件分派給對應回呼：`screenshot_request`、`screenshot_completed|failed`、`sound_play`、`subtitle_update`、`caption_update`、`iframe_config`

- 工具模組 `frontend/src/utils/iframeConfig.js`
  - `parseIframeConfigFromParams` / `sanitizeIframeConfig` / `buildQueryFromIframeConfig`
  - 移除重複 ID、補齊 col/row span、統一 ratio/gap/columns 的邏輯

### 協作建議

- 新增場景時，若需要截圖或字幕，只要調用上述 hooks，不需再複製 `App.jsx` 的老程式碼。
- 若要擴充 WebSocket 事件，先在 `useControlSocket` 增加對應的 `payload.type`，再把回呼從 `App.jsx` 傳入。
- App 若需更多狀態（例如未來的「視角預設」hook），沿用同樣模式：先在 `hooks/` 建立具體邏輯，再於 `App.jsx` 引入，保持主組件規模一致。

---

## 5. 資料流與互動

- 向量搜尋：`SlideMode / OrganicRoom / SearchMode` → api.js → 後端 `vector_store` → ChromaDB
- 親緣圖：`KinshipScene / SlideMode(kinship)` → `GET /api/kinship` → metadata JSON 聚合
- 截圖 → 上傳：前端（SearchMode 或其他）→ `POST /api/screenshots` → 後端儲存至 `screen_shots/`
- 音效播放：管理端 API 觸發 `POST /api/sound-play` → WS 廣播 `sound_play` → SoundPlayer 播放
- Iframe 配置：前端載入或等待 WS → 更新面板 `src` 切換

---

## 6. 效能與使用者體驗

- 圖片載入：
  - SlideMode 可加入「預先載入下一張」的簡單 prefetch（建議）
  - SearchMode 網格可依視窗大小做 lazy loading（IntersectionObserver，建議）
- R3F 場景：大量 billboards/texture 時，注意材質與幀率；盡量共用 texture/material；控制 LOD 與動畫開關
- WebSocket：單一連線多事件共用（SoundPlayer），避免在多元件各自建立連線（建議集中一個 hook/context）

---

## 7. 錯誤處理與相容性

- 後端 400/404/500 統一以文字訊息顯示；`SearchMode` 已做二段回退
- 圖片 404：前端以 `onError` 設置替代外觀
- CORS：若前後端不同源部署，需後端開啟 CORS（目前未設置，見後端概論建議）

---

## 8. 開發與建置

- 開發：
  ```bash
  cd frontend
  npm run dev
  ```
- 建置：
  ```bash
  npm run build
  # 產出於 frontend/dist/
  ```
- 靜態檔案可由任意伺服器提供，或掛載至後端（參見 spec.md 建議）

---

## 9. Refactor 建議（前端）

- 路由/模式統一：
  - 抽出 `ModeRouter` 與 `useQueryParams()`（集中處理 URL 解析與狀態），避免各模式重複解析
- 狀態與上下文：
  - 提供 `AppContext`（含 API base、imagesBase、WebSocket 實體、全域錯誤 handler）
  - `SoundPlayer` 的 WS 連線抽成 `useRealtime()` hook，供各處訂閱（`sound_play`、`screenshot_*`、`iframe_config`）
- API 模組化：
  - `api.js` 拆為 `api/search.ts`, `api/kinship.ts`, `api/screenshots.ts`（或維持單檔但導出明確型別，建議漸進轉 TS）
  - 統一錯誤結構與重試策略
- 三維場景：
  - 佈局常數集中到 `config/layout.ts`；動態參數（FOV/距離）接成 props，便於未來做可視化調參
  - 大型模式以 lazy/dynamic import，減少初始 bundle
- 效能：
  - SlideMode 加入 prefetch 策略；SearchMode 的圖片 lazy-load；大型場景 Suspense 區隔
- 型別與測試：
  - 逐步引入 TypeScript（API 回傳型別、元件 props），搭配簡易單元測試（模式切換、URL 解析、API 包）

---

## 10. 已知差異/注意

- `:en/:zh` 後綴的雙語向量索引目前僅清理腳本（後端）存在；前端僅在顯示時剔除後綴，實際資料仍單一語系索引
- 後端尚未配置 CORS，中大型部署建議優先補上

---

（文件結束）
