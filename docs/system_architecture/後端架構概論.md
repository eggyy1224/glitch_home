# 後端架構概論（Backend Architecture Overview）

> 狀態: 與現況程式碼同步  
> 最後更新: 2025-11-15

---

## 1. 技術棧與啟動流程

- **Runtime**：Python 3.11+、FastAPI 0.115、Uvicorn 0.30。`app/main.py` 建立 app、掛上 CORS（允許所有來源）與靜態目錄 `/generated_images`、`/generated_sounds`，再註冊各領域 Router。
- **核心依賴**：
  - Pillow、numpy：影像處理、拼貼切片。
  - google-genai：Gemini 影像混合／分析。
  - openai SDK：文字/影像 embedding、TTS。
  - chromadb PersistentClient：維護 offspring 圖像向量索引。
  - httpx：ElevenLabs 音效 API、OpenAI TTS REST。
- **生成與儲存**：所有新生成的圖片放在 `settings.offspring_dir`，對應 metadata (`backend/metadata/offspring_*.json`)；音效會寫到 `settings.generated_sounds_dir` 並對應 metadata。

---

## 2. 目錄與模組概覽

```
backend/app/
├── main.py              # FastAPI 入口、CORS、靜態掛載
├── config.py            # Settings dataclass + dotenv + 路徑正規化
├── api/                 # 各領域 Router
│   ├── storage.py       # iframe/collage 設定、相機預設、截圖上傳
│   ├── generation.py    # Gemini 混合 & offspring 列表
│   ├── indexing.py      # 嵌入索引 + 搜尋
│   ├── kinship.py       # 親緣查詢/重建/統計
│   ├── collage.py       # 拼貼任務佇列
│   ├── screenshot.py    # 截圖分析、音效、bundle
│   ├── sound.py         # 音效檔列出/串流、TTS、speak-with-subtitle、sound-play
│   └── realtime.py      # subtitle/caption、screenshot request、WebSocket
├── services/            # 業務邏輯層
├── models/              # Pydantic schema（`schemas.py`、`collage.py`、`iframe.py`）
└── utils/               # embeddings、Gemini client、檔案/metadata util
```

`backend/metadata/` 用來存：
- `camera_presets.json`
- `iframe_config*.json` + `snapshots/iframe_config/**`
- `collage_config*.json`
- `kinship_index.json`
- 各 offspring/音效/拼貼的 metadata 檔案

---

## 3. 設定與環境變數（`config.Settings`）

- **金鑰與模型**：`GEMINI_API_KEY`、`ELEVENLABS_API_KEY`、`OPENAI_API_KEY`、`MODEL_NAME`（預設 `gemini-2.5-flash-image-preview`）、`OPENAI_EMBEDDING_MODEL`、`OPENAI_VISION_MODEL`、`OPENAI_TTS_MODEL/VOICE/FORMAT`。可透過 `GENAI_USE_VERTEX` + `VERTEX_PROJECT/LOCATION` 切換 Vertex 端點。
- **資源路徑**：
  - `GENES_POOL_DIR` / `GENES_POOL_DIRS`：父圖來源（多個資料夾會自動展開）。
  - `OFFSPRING_DIR`：生成結果；對應靜態路由 `/generated_images`。
  - `METADATA_DIR`：各種 JSON metadata、config。
  - `SCREENSHOT_DIR`：前端回傳場景截圖的儲存處。
  - `GENERATED_SOUNDS_DIR`：音效/TTS 輸出 + `/generated_sounds` 靜態掛載。
  - `CHROMA_DB_PATH`、`CAMERA_PRESETS_FILE`。
- **其他參數**：`IMAGE_SIZE` 控制送進 Gemini/分析時的最大邊；所有相對路徑會在 `__post_init__` 中轉為 repo-root 絕對路徑，避免工作目錄不同造成錯誤。

---

## 4. API Router 速覽

- **storage_router (`api/storage.py`)**
  - `GET/PUT /api/iframe-config`：載入/覆寫配置；支援 `client` 參數分客戶端，也提供 `snapshot`, `snapshots`, `restore` 三組端點。
  - `GET/PUT /api/collage-config`：載入/儲存 collage 控制台的預設圖集，回傳來源（global/client）與 `updated_at`。
  - `GET/POST/DELETE /api/camera-presets`：Kinship 視角 CRUD。
  - `POST /api/screenshots`：儲存前端上傳的 PNG/JPG，若帶 `request_id` 會呼叫 screenshot queue 標記完成/失敗。
- **generation_router (`api/generation.py`)**
  - `POST /api/generate/mix-two`：Gemini 混合生成，支援自訂 parents/prompt/尺寸/格式/resize 模式。
  - `GET /api/offspring-images`：列出 offspring 目錄內所有檔名供前端選圖。
- **indexing_router (`api/indexing.py`)**
  - `/api/index/offspring`, `/api/index/image`, `/api/index/batch`：指示 ChromaDB 重新索引。
  - `/api/search/text`, `/api/search/image`：向量搜尋（可指定 `include_deprecated`）。
  - `/api/index/mark-deprecated`：掃描 `offspring_images/deprecated/` 並更新 metadata。
- **kinship_router (`api/kinship.py`)**
  - `GET /api/kinship?img=`：回傳 parents/children/siblings/ancestors 與圖形化資料。
  - `POST /api/kinship/rebuild`、`GET /api/kinship/stats`：重建與檢視 kinship index。
- **collage_router (`api/collage.py`)**
  - `POST /api/generate-collage-version`：建立拼貼任務（支援行列數、旋轉、seed、模式等）。
  - `GET /api/collage-version/{task_id}/progress`：輪詢任務狀態/結果。
- **screenshot_router (`api/screenshot.py`)**
  - `POST /api/analyze-screenshot`：Gemini 場景分析（可帶 `request_id`）。
  - `POST /api/sound-effects`：ElevenLabs 產生音效並 attach 到指定 request。
  - `POST /api/screenshot/bundle`：分析 + 產生音效的合併流程。
- **sound_router (`api/sound.py`)**
  - `GET /api/sound-files` / `GET /api/sound-files/{filename}`：音效清單與串流。
  - `POST /api/sound-play`：透過 WebSocket 廣播播放命令。
  - `POST /api/tts`：OpenAI TTS，並可選擇立即廣播播放。
  - `POST /api/speak-with-subtitle`：一次性產生 TTS + 設定字幕。
- **realtime_router (`api/realtime.py`)**
  - `GET/POST/DELETE /api/subtitles`、`/api/captions`：透過 `SubtitleManager`/`CaptionManager` 管理 timed text 並同步到 WS。
  - `GET /api/clients`：列出目前 WebSocket 客戶端。
  - `POST /api/screenshots/request` → `GET /api/screenshots/{id}` → `POST /api/screenshots/{id}/fail`：管理後端排程的截圖任務。
  - `WebSocket /ws/screenshots`：接收 `hello` 後綁定 client id，並推送 screenshot/sound/caption/iframe/collage 事件。

---

## 5. 資料流與 Mermaid 圖

- **請求路徑**：任一 Client（前端或維運腳本）透過 REST `/api/*` 進入 Router，Router 依責任分派至 `services/*`。Services 會操作檔案系統（offspring、screenshots、sounds、metadata）、ChromaDB、以及外部 AI 供應商（Gemini/OpenAI/ElevenLabs）。
- **即時事件**：`screenshot_queue` 與 `realtime_broadcaster` 配合 WebSocket `/ws/screenshots`，將 screenshot request、sound_play、iframe/collage/subtitle 更新推送到指定 client，也負責把前端上傳的截圖與狀態寫回 queue。
- **資料湖與靜態輸出**：所有生成結果都寫入 `settings.*_dir`；其中影像與音效會透過 `StaticFiles` 直接服務，metadata 則是後續索引、分析及展示的重要依據。

```mermaid
flowchart LR
  subgraph Clients
    Frontend[前端瀏覽器]
    Ops[維運腳本 / CLI]
  end
  subgraph FastAPI
    Router[/Routers\n(api/*)/]
    Services[[services.*]]
    Queue[(screenshot_queue)]
    Bus[(realtime_broadcaster)]
  end
  subgraph Storage
    Files[(offspring / screenshots /\nsounds / metadata)]
    Chroma[(ChromaDB)]
  end
  subgraph Providers
    Gemini[(Gemini)]
    OpenAI[(OpenAI\nEmbedding/TTS)]
    ElevenLabs[(ElevenLabs\nSound Effects)]
  end

  Frontend -->|REST /api/*| Router
  Ops -->|REST| Router
  Frontend -->|WS /ws/screenshots| Bus
  Router --> Services
  Services -->|寫入/讀取| Files
  Services -->|嵌入/搜尋| Chroma
  Services -->|影像生成| Gemini
  Services -->|Caption/TTS| OpenAI
  Services -->|音效| ElevenLabs
  Services -->|enqueue| Queue
  Queue -->|事件| Bus
  Bus -->|screenshot/sound/config| Frontend
  Frontend -->|POST /api/screenshots| Router
```

---

## 6. 主要服務（`backend/app/services/*`)

- **Gemini 影像生成（`gemini_image.py`）**：負責選取父圖、前處理（EXIF、縮放）、組合 prompt、呼叫 Gemini 並寫回 offspring + metadata。`generate_mixed_offspring_v2` 支援目標尺寸（width/height/max_side + resize_mode cover/fit）。
- **向量庫（`vector_store.py`）**：用 OpenAI 文字嵌入 `text-embedding-3-small` 建立 Chroma collection；缺乏嵌入時會先 `caption_image` 再嵌入。提供 sweep/index 單檔/批次、搜尋、以及 `mark_deprecated_images()`（標記位於 `deprecated/` 子資料夾的圖）。
- **親緣索引（`kinship_index.py`）**：掃描 `metadata/offspring_*.json` 抽取 parents/children，持久化為 `kinship_index.json`，提供 parents_of/children_of/siblings_of/ancestors_levels_of API，並在缺檔時自動重建。
- **拼貼任務（`collage_version.py`）**：定義 `CollageTaskManager`（記憶體，在 5 分鐘後清除完成任務）與 PIL/Numpy 的切片邏輯、邊緣顏色比對、旋轉/抖動/seed。結果會寫 metadata + 回傳 tile mapping。
- **配置管理**
  - `iframe_config.py`：支援 per-client config、檔名驗證、防止 Path traversal、snapshot（存於 `metadata/snapshots/iframe_config/<client>/`）。
  - `collage_config.py`：類似結構，回傳 `source`（default/global/client）與更新時間。
  - `camera_presets.py`：JSON 檔案版 CRUD，並自動填入 `updated_at`。
- **即時通訊**
  - `realtime_bus.py`：追蹤目前 WebSocket 連線、廣播 sound/iframe/collage/subtitle/caption，並允許 target client id。
  - `screenshot_queue.py`：以 in-memory dict 存 request 狀態，產生隨機 id，並在狀態變動時透過 `realtime_broadcaster` 發送 `screenshot_request/completed/failed/sound_effect_ready`。
- **截圖與分析**
  - `screenshots.py`：驗證副檔名、建立 `scene_<timestamp>_<token>.png/jpg`、回傳絕對與相對路徑。
  - `image_analysis.py`：用 Gemini 2.5 Flash，提供 summary 與 segments，限制輸入尺寸避免超時。
  - `api/screenshot_helpers.py`：解析 `image_path` 或 `request_id` → 實際檔案，並建議音效 prompt。
- **音訊**
  - `sound_effects.py`：呼叫 ElevenLabs Text-to-Sound Effects API，命名並寫 metadata（含 SHA256），支援 loop/duration/prompt influence。
  - `tts_openai.py` + `api/sound_helpers.py`：使用 OpenAI `/v1/audio/speech` 輸出 mp3/wav/opus…，自動生成安全檔名並可在 4xx 失敗時重試（移除 instructions）。`speak-with-subtitle` 另外會呼叫 `SubtitleManager` 設定字幕並透過 WS 廣播。
- **字幕/說明文字**：`subtitles.py`、`captions.py` 都封裝 `TimedTextManager`，支援全域或 per-client 狀態、有效時間、自動到期清除。
- **嵌入工具（`utils/embeddings.py`）**：提供 `embed_text`、`embed_image`、`caption_image` 等共用邏輯；必要時 fallback 為「先 caption 再 embed」。
- **共用工具**：`utils/fs.py`（確保目錄）、`utils/metadata.py`（寫 metadata、SHA256、UTC timestamp）。

---

## 7. 資料流程與狀態

### 7.1 截圖與指令佇列
1. 後端透過 `/api/screenshots/request` 建立 request（可帶 `client_id`）；`ScreenshotRequestQueue` 會推送 `screenshot_request` 到指定 client。
2. 前端完成截圖後呼叫 `POST /api/screenshots`（夾帶 request_id/client_id）；成功時 queue 標記 completed，並透過 WS 發送 `screenshot_completed`。
3. 若前端或後端失敗，可呼叫 `/api/screenshots/{id}/fail` 或 queue 自行標記失敗；狀態會在後端保留，供 `/api/screenshots/{id}` 查詢。
4. `api/screenshot` 裡的分析/音效/bundle 也可透過 request_id 綁定——一旦音效生成成功，queue 會在 `sound_effect_ready` 事件中附上路徑，前端 SoundPlayer 得以自動載入。

### 7.2 設定廣播流程
- `/api/iframe-config` / `/api/collage-config`：寫入時會呼叫 `realtime_broadcaster.broadcast_*`，將 config 與 target client id 推給所有連線，使前端進入遠端鎖定狀態。
- `/api/camera-presets`：雖未透過 WS 廣播，但 Kinship 前端開啟時會先拉一次清單；預設會找名為 `center` 的 preset。

### 7.3 拼貼任務
- 前端送出 `/api/generate-collage-version` 後，Router 會建立 task id、啟動 `asyncio.create_task` 跑 `generate_collage_version`（包在 `run_in_threadpool`）。
- 任務進度透過 `progress_callback` 更新 task manager；前端以輪詢 `/progress` 方式取得 stage、message、完成後的輸出檔名/路徑/metadata。
- 目前 task manager 為記憶體型，重啟後會遺失紀錄，且沒有長期儲存輸出檔（需自行搬運）。

### 7.4 搜尋與索引
- `/api/search/image` 允許使用任意檔案路徑；若檔案缺嵌入會在 runtime caption+embed。為提高穩定性，`_iter_offspring_images` 只接受 `offspring_dir` 下的 png/jpg。
- `index_offspring_batch` 支援 offset/batch-size，可搭配排程分段全量索引。
- `mark_deprecated_images`：掃描 `offspring_images/deprecated/**`，在 Chroma metadata 寫入 `deprecated=true`，供前端 optional 過濾。

### 7.5 親緣資料
- `kinship_index.build_and_save()` 根據 metadata JSON 的 `parents` 欄位建構 `parents_map` / `children_map`；查詢 `/api/kinship` 時會再檢查檔案是否存在於 `offspring_dir`，避免 metadata 遺失。
- 回傳內容包含 `lineage_graph`、`ancestors_by_level`、`root_ancestors`。前端可用 `depth` 控制祖先層數（-1 = 無限）。

### 7.6 音訊與字幕
- `sound_play`：由 `/api/sound-play` 觸發，後端會查檔案存在並把 URL + filename 廣播。前端只需監聽 WS `sound_play`。
- `tts` 與 `speak-with-subtitle`：執行成功後會把 `url` 回傳給呼叫端；若 `auto_play=true`，server 會透過 WS 推送 `sound_play`。`speak-with-subtitle` 另外會呼叫 `SubtitleManager` 並廣播 `subtitle_update`。

---

## 8. 既知限制與建議

- **揮發性狀態**：`ScreenshotRequestQueue`、`CollageTaskManager` 都只在記憶體中，重啟後資料會遺失；若要跨機或高可靠，建議改用 Redis/DB。
- **缺乏權限控管**：目前所有 API（生成、索引、刪除 preset）皆無驗證；部署到公開環境前需補 auth/速率限制。
- **觀測性**：多數服務仍以 `print()` 記錄（ex. `kinship_index`），建議改為結構化 logging。
- **錯誤處理**：Gemini/ElevenLabs/OpenAI 呼叫的例外大多包成 `RuntimeError`/`ValueError`，但未分類告警。若要長期運行，應增加重試邏輯與告警。
- **大型輸出管理**：拼貼任務與 Gemini 輸出只存在檔案系統，沒有提供 CDN/簽名 URL；若要遠端存取需另外串接 object storage。

以上覆蓋目前 `backend/` 主要模組與資料流程，可做為前後端協作與 debugging 的參考地圖。
