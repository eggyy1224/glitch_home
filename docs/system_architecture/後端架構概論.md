# 後端架構概論（Backend Architecture Overview）

> 狀態: 與現況程式碼同步  
> 最後更新: 2025-11-04

---

## 1. 概述與技術棧

- 語言與框架：Python 3.13 + FastAPI 0.115.0（Uvicorn 0.30.6）
- 依賴核心：
  - 影像處理：Pillow 10.4.0
  - 嵌入與搜尋：OpenAI Python SDK（text-embedding-3-small）、ChromaDB（PersistentClient）
  - 圖像生成：google-genai（Gemini API）
  - 音效生成：httpx（ElevenLabs Text-to-Sound Effects API）
  - 旁白 TTS：httpx（OpenAI Audio Speech API）
  - 設定：python-dotenv；Pydantic v2（models/schemas.py）
- 靜態掛載：
  - `/generated_images` → `settings.offspring_dir`
  - `/generated_sounds` → `settings.generated_sounds_dir`

---

## 2. 目錄與模組

```
backend/app/
├── main.py                    # FastAPI 入口與全部路由
├── config.py                  # Settings (環境變數→實際路徑/參數)
├── services/
│   ├── gemini_image.py        # 圖像混合生成（Gemini）
│   ├── vector_store.py        # ChromaDB 整合與搜尋
│   ├── image_analysis.py      # 圖像分析（OpenAI 視覺）
│   ├── sound_effects.py       # 音效生成（ElevenLabs）
│   ├── tts_openai.py         # 旁白 TTS（OpenAI Audio Speech）
│   ├── collage_version.py     # 拼貼版本生成
│   ├── collage_config.py      # 拼貼配置管理
│   ├── screenshots.py         # 截圖上傳儲存
│   ├── screenshot_requests.py # 截圖請求與 WebSocket 廣播
│   ├── camera_presets.py      # 相機預設 CRUD
│   └── iframe_config.py       # Iframe 多面板配置載入/儲存/解析
├── models/
│   ├── schemas.py             # Pydantic 請求/回應模型
│   ├── iframe.py              # Iframe 模型/解析產物
│   └── collage.py             # Collage 配置模型
└── utils/
    ├── embeddings.py          # OpenAI 嵌入/視覺描述封裝
    ├── gemini_client.py       # Gemini 客戶端
    ├── metadata.py            # 生成 metadata 檔案寫入
    └── fs.py                  # 檔案系統 utilities
```

---

## 3. 設定（config.Settings）

- 關鍵環境變數（部分）：
  - 金鑰：`GEMINI_API_KEY`, `ELEVENLABS_API_KEY`, `OPENAI_API_KEY`
  - 模型：
    - `MODEL_NAME`（預設 `gemini-2.5-flash-image-preview`）
    - `OPENAI_EMBEDDING_MODEL`（預設 `text-embedding-3-small`）
    - `OPENAI_VISION_MODEL`（預設 `gpt-4o-mini`）
    - `OPENAI_TTS_MODEL`（預設 `gpt-4o-mini-tts`）, `OPENAI_TTS_VOICE`（預設 `alloy`）, `OPENAI_TTS_FORMAT`（預設 `mp3`）
    - `GOOGLE_EMBEDDING_MODEL`（`text-embedding-004`）、`GOOGLE_IMAGE_EMBEDDING_MODEL`（`multimodalembedding`，目前未啟用）
  - 目錄與檔案：
    - `GENES_POOL_DIR`（單一路徑，相容）
    - `GENES_POOL_DIRS`（多路徑，逗號分隔）
    - `OFFSPRING_DIR`（預設 `backend/offspring_images`）
    - `METADATA_DIR`（預設 `backend/metadata`）
    - `SCREENSHOT_DIR`（預設 `screen_shots`）
    - `GENERATED_SOUNDS_DIR`（預設 `backend/generated_sounds`）
    - `CHROMA_DB_PATH`（預設 `backend/chroma_db`）
    - `CAMERA_PRESETS_FILE`（預設 `backend/metadata/camera_presets.json`）
  - 其他：
    - `IMAGE_SIZE`（送入模型前的上限邊縮放，預設 1024）
    - `GENAI_USE_VERTEX`, `VERTEX_PROJECT`, `VERTEX_LOCATION`, `ENABLE_IMAGE_EMBEDDING`（目前屬保留/未啟用）
- 相對路徑均在 `__post_init__` 轉為專案根目錄下的絕對路徑，便於跨工作目錄執行

---

## 4. 服務模組（services）

### 4.1 gemini_image.py（圖像生成）
- 來源：
  - 基因池多目錄：`settings.genes_pool_dirs`（自動掃描 PNG/JPG）
  - 指定父圖：支援傳入檔名/相對路徑/絕對路徑（解析順序依目錄列表）
- 生成模型：`MODEL_NAME`（預設 Gemini 2.5 Flash Image Preview）
- 生成路徑：`settings.offspring_dir`
- 命名：`offspring_YYYYMMDD_HHMMSS_XXX.{png|jpeg}`
- 輸出 metadata（JSON）：
  - `parents`, `parents_full_paths`, `model_name`, `prompt`, `strength`, `created_at`, `output_image`, `output_format`, `output_size`
- 介面：
  - `generate_mixed_offspring(count=2)`：隨機抽樣父圖
  - `generate_mixed_offspring_v2(parents|count|prompt|strength|output_*|resize_mode)`：擴充參數與尺寸策略（fit/cover/max_side/顯式寬高）

### 4.2 vector_store.py（向量庫）
- 客戶端：`chromadb.PersistentClient(path=settings.chroma_db_path)`
- Collections：
  - `offspring_images`（images）：以檔名作為 id，`metadatas` 內附帶生成 JSON 內容
  - `text_queries`（可選）
- 嵌入策略（現況）：
  - 主要：OpenAI `text-embedding-3-small`
  - 以圖搜圖：先嘗試用資料庫已存在之向量（`include=["embeddings"]`），若無則 `embed_image()`（實作：先產 caption 再 text-embedding）
- 索引：
  - `index_offspring_image(basename, force=False)`：索引單張（抓 `backend/metadata/<stem>.json` 合併 metadata）
  - `sweep_and_index_offspring(limit=None, force=False)`：遍歷目錄（指令端點化為 `/api/index/offspring`）
  - `index_offspring_batch(batch_size=50, offset=0, force=False)`：分頁索引（穩定順序）
- 搜尋：
  - `search_images_by_text(query, top_k)`
  - `search_images_by_image(image_path, top_k)`：彈性路徑解析 + DB 命中快取 → 回退 embedding
- 注意：檔頭註解仍描述「由 Google GenAI 產生向量」已不符現況，後續會修正註解以對齊 OpenAI 策略

### 4.3 screenshots.py / screenshot_requests.py（截圖與協調）
- 上傳：`POST /api/screenshots`（multipart）
  - 儲存於 `settings.screenshot_dir`
  - 回傳：`filename`, `original_filename`, `absolute_path`, `relative_path`（若有）
  - 若附帶 `request_id`：完成後標記該請求為 completed
- 請求協調（WS）：`/ws/screenshots`
  - `screenshot_request`：後端建立 → 廣播
  - `screenshot_completed` / `screenshot_failed`
  - `sound_play`：音效播放請求（可目標特定 `client_id`）
  - `sound_effect_ready`：音效生成完成（供前端 UI 顯示，可選）
  - `iframe_config`：Iframe 配置更新
  - `collage_config`：拼貼配置更新
  - `subtitle_update`：字幕更新
  - `caption_update`：說明文字更新

### 4.4 image_analysis.py / sound_effects.py（分析與音效）
- 圖像分析：OpenAI `gpt-4o-mini` 生成 `summary` 與 `segments`
- 音效生成：ElevenLabs `eleven_text_to_sound_v2`（`duration_seconds`, `prompt_influence`, `loop`, `output_format`）

### 4.5 tts_openai.py（旁白 TTS）
- 端點：`POST /api/tts`
- 請求：`{ text, instructions?, voice?, model?, output_format?, filename_base?, speed?, auto_play?, target_client_id? }`
- 行為：呼叫 OpenAI Audio Speech API → 寫入 `generated_sounds/` → 回傳 `{ tts: {...}, url }`
- 若 `auto_play=true`：透過 WebSocket 廣播 `sound_play` 給指定 `client_id`
- 可選：`speed`（0.25–4.0），控制語速（預設 1.0）；`instructions` 用於指定語氣/口音/說話風格
- 環境變數：
  - `OPENAI_TTS_MODEL`（預設 `gpt-4o-mini-tts`）
  - `OPENAI_TTS_VOICE`（預設 `alloy`）
  - `OPENAI_TTS_FORMAT`（預設 `mp3`）
- 綁定流程：
  - `POST /api/analyze-screenshot`
  - `POST /api/sound-effects`
  - `POST /api/screenshot/bundle`：分析 + 產音，一次完成並（若有）回寫到截圖請求紀錄

### 4.6 collage_version.py（拼貼版本生成）
- 功能：將多張圖像切片後重新組合，產生新的拼貼版本
- 匹配 / 處理模式：`kinship`、`luminance`、`wave`、`source-cluster`、`random`、`weave`、`rotate-90`
- `allow_self=true` 或 `mode=rotate-90` 時允許單張圖；其餘模式需至少兩張圖
- `base` 參數支援 `first` / `mean`（目前 `mean` 仍等同第一張）
- 任務管理：`CollageTaskManager` 追蹤非同步生成進度
- 端點：
  - `POST /api/generate-collage-version`：建立生成任務（返回 `task_id`）
  - `GET /api/collage-version/{task_id}/progress`：查詢進度與結果
- 主要參數範圍：
  - `rows`/`cols`：1-300（預設 12×16）
  - `resize_w`: 256-8192 px（預設 2048）
  - `pad_px`: 0-100；`jitter_px`: 0-50
  - `rotate_deg`: 0-45 度
  - `format`: `png`、`jpg`、`webp`；`quality` 僅在 `jpg/webp` 有效
  - `return_map`: 控制是否回傳 tile mapping

### 4.7 collage_config.py（拼貼配置管理）
- 功能：管理拼貼模式的配置（圖像列表、網格參數等）
- 儲存位置：
  - 全域：`backend/metadata/collage_config.json`
  - 客戶端專屬：`backend/metadata/collage_config__<client>.json`
- 端點：
  - `GET /api/collage-config?client=<id>`：取得配置（客戶端專屬或全域）
  - `PUT /api/collage-config`：更新配置（可指定 `target_client_id`）
- WebSocket 推送：更新後會廣播 `collage_config` 訊息
- 配置參數：`images`, `image_count`, `rows`, `cols`, `mix`, `stage_width`, `stage_height`, `seed`

### 4.8 camera_presets.py / iframe_config.py（視角與多面板）
- 相機預設：`GET/POST/DELETE /api/camera-presets`（JSON 檔 `backend/metadata/camera_presets.json`）
- Iframe 配置：
  - `GET /api/iframe-config`：可帶 `?client=<id>` 讀取指定客戶端配置（若無則預設）
  - `PUT /api/iframe-config`：儲存配置（可帶 `target_client_id`），並透過 WS 廣播 `iframe_config`
  - 檔案：
    - 全域：`backend/metadata/iframe_config.json`
    - 客製：`backend/metadata/iframe_config__<client>.json`

---

## 5. API（集中於 main.py）

- 健康檢查：`GET /health`
- 圖像生成：`POST /api/generate/mix-two`（body 可選；無 body 時以 `count` query 落地）
- 向量索引：
  - `POST /api/index/offspring`
  - `POST /api/index/image`
  - `POST /api/index/batch`
- 搜尋：
  - `POST /api/search/text`
  - `POST /api/search/image`
- 親緣：`GET /api/kinship?img=<name>&depth=<N|-1>`（回傳 `parents/children/siblings/ancestors/ancestors_by_level/root_ancestors/lineage_graph`）
- 截圖管理：
  - `POST /api/screenshots`
  - `POST /api/screenshots/request`
  - `GET /api/screenshots/{request_id}`
  - `POST /api/screenshots/{request_id}/fail`
- 分析/音效：
  - `POST /api/analyze-screenshot`
  - `POST /api/sound-effects`
  - `POST /api/screenshot/bundle`
- 音效文件與播放：
  - `GET /api/sound-files`（列檔）
  - `GET /api/sound-files/{filename}`（串流）
  - `POST /api/sound-play`（廣播 `sound_play`）
- TTS 旁白：
  - `POST /api/tts`（產生 TTS 音訊）
- 拼貼生成：
  - `POST /api/generate-collage-version`（建立拼貼生成任務）
  - `GET /api/collage-version/{task_id}/progress`（查詢進度）
- 拼貼配置：
  - `GET /api/collage-config`（取得配置）
  - `PUT /api/collage-config`（更新配置）
- 字幕與說明文字：
  - `GET /api/subtitles`（取得字幕）
  - `POST /api/subtitles`（設定字幕）
  - `DELETE /api/subtitles`（清除字幕）
  - `GET /api/captions`（取得說明文字）
  - `POST /api/captions`（設定說明文字）
  - `DELETE /api/captions`（清除說明文字）
- 多客戶端管理：
  - `GET /api/clients`（列出在線客戶端）
- Iframe 配置：
  - `GET /api/iframe-config`
  - `PUT /api/iframe-config`
- WebSocket：`/ws/screenshots`（hello 後註冊 `client_id`，接收未完成請求補送）

---

## 6. 關鍵實作細節

- 路徑解析（截圖/影像）：
  - `_resolve_screenshot_path()` 嘗試 absolute、專案根、`SCREENSHOT_DIR`（含 basename）等多種候選
  - `search_images_by_image()` 在 DB 命中時可跳過檔案存在檢查（直接查向量）
- 併發與阻塞：
  - 影像分析與音效生成以 `run_in_threadpool()` 包裹，避免阻塞 event loop
  - WS 廣播採線上連線清單，傳送失敗會移除連線
- 安全與驗證：
  - `iframe_config` 會檢查檔名（僅允許 offspring 目錄下存在之檔）
  - 音效檔名以 `os.path.basename` 清洗，拒絕路徑穿越
  - 生成與上傳統一檔名規則；metadata 寫入失敗會保底處理
- 記錄與除錯：
  - `vector_store.py` 部分包含 `print()` 偵錯訊息；建議後續改為 logging

---

## 7. 部署與靜態資源

- 靜態掛載：`/generated_images`, `/generated_sounds` 已在 app 啟動時 mount
- 前端靜態：目前未整合 `frontend/dist` 到 FastAPI；可依需求 `app.mount("/", StaticFiles(...))`
- 反向代理：可參考 `spec.md` 的 Nginx 設定（含 WebSocket 升級）

---

## 8. 缺漏與風險

- CORS：目前未加入 `CORSMiddleware`，跨源開發（vite 5173 → api 8000）須手動設定；建議儘速補上
  - **更新**：已加入 `CORSMiddleware`，允許所有來源（開發環境）
- 向量策略註解不一致：`vector_store.py` 檔頭仍敘述 Google 來源；實際使用 OpenAI 嵌入，需修正文檔
- 雙語索引：`cleanup_zh.py` 僅做清理；尚未正式產生 `:zh/:en` 版本向量
- 持久化：截圖請求目前為記憶體資料結構；若需多實例/重啟存活，建議導入 DB
- 拼貼任務管理：`CollageTaskManager` 為記憶體實作，任務在重啟後會遺失；建議持久化或改用外部任務佇列

---

## 9. Refactor 建議（後端）

- 路由拆分：
  - 以 FastAPI `APIRouter` 按領域分拆（search/index、kinship、screenshots、sounds、tts、collage、iframe、camera、generate）
  - **更新**：已部分拆分為 `media_router`、`storage_router`、`realtime_router`
- 設定與依賴：
  - 將 `Settings` 與外部客戶端（OpenAI/Chroma/Gemini）以 DI 方式注入，便於測試
- CORS 與中介層：
  - 加入 `CORSMiddleware`（允許前端開發來源、允許 WS）
- 錯誤處理與日誌：
  - 統一 `HTTPException` 錯誤碼與訊息；移除 `print()` 改為 `logging`
- 背景任務：
  - 長時作業（索引/生成）可改以背景隊列（如 asyncio 任務、或 Celery/RQ 視規模）
- 資料持久化：
  - 對 `screenshot_requests_manager` 提供持久化（SQLite/Redis）以支援重啟容錯
- 文件與型別：
  - `vector_store.py` 修正檔頭註解；於 `schemas.py` 擴充回應型別（`lineage_graph` 等）
- 安全性：
  - 更嚴格的檔名/路徑校驗與 MIME 檢查；ElevenLabs 失敗重試/節流

---

## 10. 驗證與維運

- 健康檢查：`/health`（可擴充回報 Chroma 連線、目錄可寫等）
- 可觀測性：導入結構化日誌與指標（請求耗時、Queue 深度、WS 連線數）
- 測試：
  - 單元：vector_store（索引/查詢/回退）、iframe_config 驗證、screenshots 存取
  - 整合：`/api/screenshot/bundle` 端到端（假資料或打 stub）

---

（文件結束）
