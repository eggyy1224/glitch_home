# backend/offspring_images 圖像系譜學

本筆記整理專案核心資料夾 `backend/offspring_images` 的歷史、來源與使用模式，幫助後續向量化與視覺親緣研究。

> 精煉閱讀版（≤200 行）請見：`docs/圖像系譜學_精煉版.md`。本檔保留完整細節、數據與歷史討論；後續長篇技術附錄與量測報告將移至 `backend/reports/`。

## 1A. 圖像系譜學綱領（風格 × 技術）

本章作為全文件的總論：定義「風格表型」如何由「技術基因」與「親緣結構」共同決定，並給出可驗證的對應關係與操作流程。

- 基本對應（Phenotype = f 技法 × 親緣 × 提示）
  - `Phenotype = F(operators, parents, prompt, params)`
  - 其中 `operators` 是生成/拼貼過程中的「技術運算」；`parents` 是父圖集合與其型別（photo/ai/offspring）；`prompt` 與 `params` 為文字與數值約束。

- 技法運算子（Operators，抽象層）
  - `overlay-halo`：在自然/人像上疊加放射/發光圖騰（早期常見）。
  - `restage-compose`：拆解父圖元素、重置布局與視角（中期主力）。
  - `mask-montage`：以蒙版方式拼貼多來源區塊（中期插畫/舞台化質感）。
  - `collage-kinship`：格網化重組（rows×cols），依相似度選片、以 `base` 偏壓；晚期主力。
  - `luminance-blend`：以亮度/對比為主的相容度優先拼接（晚期常與 kinship 同時運行）。
  - `wave/edge-align`：依邊緣方向延展的條帶式拼貼（造成「斜向流紋」）。
  - `source-cluster`：先做來源聚類，再於群內挑片（降低 seam、增強同源凝聚）。

- 風格表型座標（Phenotype Axes，觀測層）
  - `narrativity`（敘事性）｜`motif-solidity`（母題完整度）｜`texture-grain`（顆粒尺度）
  - `spatial-continuity`（空間連續性/縫合能量）｜`color-entropy`（色相熵）｜`contrast`（明暗張力）
  - `scale/format`（解析度與幅向）｜`iconography`（符號庫密度，如面具、圓渦、黑獸）

- 風格—技術「經驗律」（可檢驗）
  1) `overlay-halo` ↑ → `motif-solidity` ↑、`narrativity` ↑、局部 `contrast` ↑（夜景＋圖騰）。
  2) `restage-compose` + `mask-montage` ↑ → `iconography` ↑、`narrativity` 中等、`spatial-continuity` ↓（舞台化拼貼）。
  3) `collage-kinship` 的 `rows*cols` ↑ → `texture-grain` ↑、`motif-solidity` ↓、`narrativity` ↓、`scale/format` ↑（晚期親緣紋理）。
  4) `base:"first"` 偏壓 → 整體色相/亮度向第一父圖偏移，形成「色彩脈絡記憶」。
  5) `offspring-ratio`（父圖中 offspring 比例）↑ → `iconography` 凝聚、`color-entropy` 先升後降（擴散→收斂）。
  6) `seed-injection`（新 wc/photo 批次）日 → `color-entropy`、`narrativity` 暫時上升；次日起回授使 `motif-solidity` 凝聚。

- 時期劃分以運算子占比為準
  - 早期：`overlay-halo` 為主，`restage-compose` 次之。
  - 中期：`restage-compose` + `mask-montage` 為主，`offspring-ratio` 高。
  - 晚期：`collage-kinship`（40×40）+ `luminance/wave` 為主；解析度、直幅固定化。

- 工作流程（無須程式亦可操作）
  1) 取樣一日作品，逐張標出主運算子（上列 6 類）。
  2) 以 7 個表型座標做肉眼評級（1–5），形成「日向量」。
  3) 畫出時間序列：日向量折線 + `offspring-ratio`（從 metadata 估）。
  4) 在「轉折日」檢視父圖型別與運算子變化，即可建立「技法→風格」的因果鏈。

## 1. 資料夾定位
- FastAPI 生成服務的預設輸出目錄，所有 Gemini 2.5 Flash Image 生成結果會落在這裡（檔名前綴 `offspring_YYYYMMDD_HHMMSS_seq`）。
- 相對應的親緣 metadata 存在 `backend/metadata/offspring_*.json`，供 lineage 視覺化與搜尋使用。
- 人工精選的結果會被搬運到 `夜遊 - 毛刺/選中的後代`；部分淘汰或比較用影像則被收納到 `backend/offspring_images/deprecated/`。

## 2. 規模與時間軸
- 目前掃描結果：影像總數 **1366**（`png` 1342、`jpeg` 24），總容量約 **3.7G**；其中 **82** 張位於 `backend/offspring_images/deprecated/`。
- 生成時間範圍（依檔名與 metadata）：自 **2025-09-23 08:16 (UTC)** 起，已延伸至 **2025-11-09 04:49 (UTC)**；主要高峰落在 9/24、10/04、10/08、11/08、11/09。
- metadata 與影像間仍有缺口（早先統計為 85 筆）；目前 `deprecated/` 內影像為 82 張，其餘缺漏分散在其他專案資料夾。建議持續同步 metadata 或補回複本，以免親緣追蹤出現缺口。

### 2.1 最新掃描補遺（時序重點）
- 日期排名（前 10 天，依檔名）：2025-09-24、2025-10-04、2025-10-08、2025-11-09、2025-10-06、2025-11-08、2025-10-05、2025-10-12、2025-09-25、2025-09-23。
- 尺寸與容量的演進（各取樣 40 張）：
  - 2025-09-24：約 954×1121，平均 2.07MB。
  - 2025-10-04：約 869×1193，平均 2.24MB。
  - 2025-11-08：約 1911×2694，平均 6.33MB。
  → 晚期解析度與檔案大小顯著上升。
- 直橫比例（各期取樣 ≤120 張）：
  - 2025-09-24：橫 32／直 88；2025-10-04：橫 0／直 120；2025-11-08：橫 0／直 99。
  → 中後期幾乎全面直幅化。

## 3. 檔案結構與參數
- 命名規則：`offspring_YYYYMMDD_HHMMSS_id.ext`，時間對應生成瞬間，`id` 為 3 位序號。
- metadata 欄位：
  - `parents`: 父圖清單，可跨資料夾（實拍 DSCF*、AI 生成 `wc6725_*`、其他 offspring）。
  - `model_name`: 一律為 `gemini-2.5-flash-image-preview`。
  - `prompt`: 以 `config.py` 內 `FIXED_PROMPT` 為主，占 7 成以上；其餘為手動實驗或早期模板。
  - `output_format`: 多為 `png`，約 2% 指定 `jpeg`。
  - 其他欄位可擴充（strength、自訂寬高）但目前紀錄不多。

## 4. 親代來源圖譜
- metadata 顯示每張 offspring 平均取用 2–3 張父圖；也曾實驗多至 8–10 張的混合。
- 依父圖類型計次（僅初步分類）：  
  `AI 生成 wc6725_*` ≈ 1674 次、`攝影 DSCF*/IMG_*` ≈ 646 次、`既有 offspring` 再循環 ≈ 960 次。  
  → 顯示演化過程是「實拍 + 既有 AI 圖 + 後代再繁殖」的混合式基因池。
- 目前共有 **551** 個獨特父圖來源，出現最頻繁的包括 `DSCF4385.jpg`、`DSCF7655.jpg` 等夜遊實拍，以及少數 AI 圖像（如 `wc6725_A_vast_crowd_of_East_Asian_people_in_black_suits_converg_*.png`）。這些高頻父圖構成了系譜的核心種子。

## 5. 與其他影像群的關聯
- `夜遊 - 毛刺/攝影圖像/*` 與 `夜遊 - 毛刺/AI生成靜態影像` 即為 genes pool 來源；環境變數 `GENES_POOL_DIRS` 已指向這些資料夾。
- 主題性整理（`projectP`, `夢遊`, `尋山問境` 等）多為從此資料夾「搬運」出去的 offspring，用於策展或展示構想。這些子集合與 metadata 仍保持同一套命名，可直接對接親緣追蹤。
- `selected_offspring_analysis.py` 與 `scripts/apply_selected_to_scene.py` 都是以 `夜遊 - 毛刺/選中的後代` 為輸入，後者再將選定 offspring 投影至 `場地模擬/3A.jpg` 等展場照片。

## 6. 研究建議
1. **同步檢查缺失影像**：對 metadata 指向但已遺失的 85 張 offspring 作補檔或標註，避免 lineage 圖與向量資料庫出現死連結。
2. **標註父圖類型**：可將 `parent_type` 結果寫回 metadata，後續在親緣樹或向量檢索時便能快速分辨「實拍 vs. 生成」。
3. **時間序列分析**：每日輸出量顯示創作階段，可視需求把不同時期的 offspring 分段建索引，比較風格演進。
4. **向量化批次**：依現有命名與 metadata 批次抽取 embedding；若遇到被搬移的圖，可透過同名檔案於其他資料夾補齊。

此筆記後續若有新的生成批次或 metadata schema 變動，建議同步更新，以維持系統的系譜清晰度。

## 7. 內容層分析（Visual Features）

為補足「只談來源與流變、不看圖像本身」的缺口，專案已提供基於 Pillow 的輕量內容特徵擷取腳本，可對每張 offspring 計算下列視覺特徵並彙整統計：

- 亮度與對比：`mean_luminance`、`luminance_std`
- 色彩與色調：`mean_saturation`、`dominant_hue_bin`（12 分箱）、前 5 色 `palette_hex`
- 紋理/細節：`edge_density`（邊緣密度）
- 構圖：`symmetry_h`（水平對稱性估計）
- 尺寸比例：`width`、`height`、`aspect_ratio`

對應程式：`backend/app/analysis/selected_offspring_analysis.py`

快速使用（分析「選中的後代」並列印摘要與逐圖描述）：

```
python3 backend/app/analysis/selected_offspring_analysis.py
```

輸出包含：
- JSON 摘要（整體統計、最高關聯的親緣配對）
- 逐圖短描述（明暗/飽和度/細節程度/主色相分箱/前三色）

若需將統計結果保存為 JSON 供前端或後續分析使用，可執行匯出腳本（見 `backend/app/analysis/export_visuals_summary.py`）：

```
python3 backend/app/analysis/export_visuals_summary.py \
  --out backend/metadata/selected_visuals_summary.json
```

之後可將內容特徵與系譜（parents/children）疊合，用於：
- 觀察母題在顏色/明度/細節上的演變趨勢
- 對齊同源作品的視覺分布（例：同一組父圖的色相分箱是否集中）
- 建立內容相似度（例如以色彩/紋理為權重）輔助親緣檢索

---

## 7. 系譜數據觀察（初步）
- 世代深度分佈（以是否含「offspring_」父圖遞推）：
  - 第1代：約507 張；第2代：約228；第3代：約156；第4代：約93；最深可達第13代（極少數）。
  - 解讀：絕大多數為淺層重組，但確實存在長鏈條的「持續自我繁殖」分支。
- 父圖類型「配對」共現（兩兩無序配對，取前幾名）：
  - ai+ai 最高（約1376 次），其後是 ai+offspring（約1110 次）、offspring+offspring（約395 次）、photo+photo（約302 次）、ai+photo（約283 次）、offspring+photo（約263 次）。
  - 解讀：AI 種子與 AI 或後代的混配最常見；實拍照片彼此或與 AI 的混配次之。
- 日別「至少含一張 offspring 父圖」的比例（節錄）：
  - 2025-09-23：0.19；09-24：0.52；09-25：0.74；09-28：0.96；09-30：1.00。
  - 2025-10-04：0.24（大量新種子注入的「創始事件」）；10-06：0.88；10-07：0.92；10-08：0.21（再次創始事件）。
  - 解讀：系統呈現「注入新種子 → 快速回授再繁殖」的週期性節奏，新種子引入日會顯著拉低回授比例。
- 高頻父圖與共現：
  - 單一父圖使用次數高者包含多張夜遊 DSCF 實拍，以及少數具標誌性的 wc6725_* AI 圖。
  - 常見共父組合（例）：`DSCF4385.jpg` + `DSCF7655.jpg`、`DSCF4385.jpg` + 某 wc6725_*、以及 offspring 與特定 offspring 的反覆配對。
  - 提醒：部分 metadata 出現同一父圖重覆列名（造成「同名自配對」統計），建議去重清理。

## 8. 圖像系譜學的工作假說
- 創始者效應（Founder effect）：
  - 10/04 與 10/08 出現父圖回授比例大降，推測是大量注入新主題（如全新 DSCF 批次或新的 wc6725_* 族），快速改變後代的風格基因頻率。
- 近親繁殖與凝聚化：
  - 多代 offspring 互為父圖的鏈條，會在局部分支產生「風格凝聚」；表現為配色、對比度、形態語彙愈趨一致。
- 漂變與突變：
  - 固定 prompt 下仍存在隨機生成差異（微漂變）；更換 prompt 或增加父圖數量視為「突變」，能跳出局部分支的風格陷阱。
- 雙模基因流（攝影×生成）：
  - photo 與 ai 的交配對可同時保留夜遊的「硬閃」語彙與 AI 的結構性重組能力，常作為新分支的起動配方。

## 9. 量化度量與驗證設計
- 系譜深度與多樣性：
  - 指標：每代節點數、分支長度分佈、Shannon 多樣性（父圖類型）、模組度（社群分群）。
  - 驗證：深度↑是否伴隨色彩/對比的收斂（可用 `selected_offspring_analysis.py` 的視覺特徵函式批次跑全體）。
- 父圖類型配比與輸出特徵：
  - 指標：photo/ai/offspring 在父圖集合中的權重，與子代的亮度、飽和度、邊緣密度、視覺對稱性之關聯（皮爾森/斯皮爾曼相關）。
  - 驗證：ai+ai 與 ai+photo 的後代在色彩/紋理的差異，是否可統計顯著。
- 共親配對的風格遺傳：
  - 指標：高頻共親二元組對其子代群之特徵均值/變異；層級迴歸模型估計「父圖 → 子代特徵」的貢獻度。
  - 驗證：特定共親是否形成「風格模組」（一種可預測的視覺表型）。
- 選中樣本的選擇壓力：
  - 指標：`夜遊 - 毛刺/選中的後代` 相對於全集的特徵差（均值差、KL 散度）、父圖類型配比、系譜深度。
  - 驗證：策展偏好是否偏向某些世代或某種父圖組合（例如高比例 photo 混配或高深度 offspring 回授）。

## 10. 向量化與系譜結合的檢索策略
- 兩層索引：
  - 語義層：以 CLIP/open_clip 向量庫（FAISS/Chroma）擷取內容相近影像。
  - 系譜層：以 DAG 索引回傳候選的「親代/同輩/子代」，形成上下文結果（非僅相似圖）。
- 查詢模式：
  - 文字→圖：跨模態檢索後，再回溯其父圖組合，協助理解風格來源（例：這張像 X，是因為繼承了 DSCF4385 的光影與某 wc6725 的構圖）。
  - 圖→圖：找最相近後，再攤開家族圖譜，提供策展所需的敘事走線（源流、分支、突變節點）。
- 解釋性標籤：
  - 將父圖類型、世代深度、共親簇（frequent pair）、生成日（創作期）寫入 metadata，檢索結果可強化可解釋性。

## 11. 策展與製作的操作性建議
- 加速分支成熟：
  - 提高 offspring 父圖占比（回授），能快速「凝聚」子系列風格；每 3–5 代注入少量 photo 或 wc 種子避免停滯。
- 觸發新系統風格：
  - 集中一日注入大量異質種子（如 10/04、10/08），製造創始事件；隔日起提高回授比例，觀察新風格的穩定化。
- 配對設計：
  - 以「高頻共親」為核心固定位，加入輪替的次要父圖，得到半可預測的風格變體列。
- 展場視覺脈絡：
  - 利用 `scripts/apply_selected_to_scene.py` 將「選中的後代」投影至場地圖，搭配家譜節點標籤（父圖縮圖/類型/世代），形成「源流牆」。

## 12. 清理與資料品質
- 父圖列表去重：
  - 移除 metadata 中同一張父圖的重覆列名（避免「自配對」誤差）。
- 路徑一致性：
  - 已確認 81 張在 `deprecated/`、另 4 張在其他資料夾；決定「搬回／同步複本／寫實際路徑」之一，並批次修正 metadata。
- 系譜衍生欄位：
  - 於 metadata 增列 `lineage_depth`、`parent_type_stats`、`frequent_pair_id`，供檢索與可視化直接使用。

## 13. 下一步（可執行）
- 批次產出：
  - 計算全體 offspring 的 `lineage_depth` 與父圖類型配比，寫回 metadata（或另存 `backend/metadata/index.json`）。
  - 跑視覺特徵（亮度、飽和、邊緣密度、對稱、調色盤），建立每代的特徵演進曲線。
- 檢索原型：
  - 以 open_clip 建向量庫，串 FAISS，實作「語義檢索 + 系譜回溯」的簡易 CLI 或 FastAPI 端點。
- 可視化：
  - 於前端新增時間軸疊圖（每日產量 + 回授比例）與共親熱度圖，輔助挑選分支作為展覽線索。

## 14. 案例閱讀與語彙庫（多模態觀察）
- DSCF4385.jpg（夜遊實拍，直式）
  - 視覺語彙：放射狀摺疊紙面、黃紅主色、連續紋樣與符號圖騰，中心漩渦式聚焦；高飽和、邊緣清晰、具反光。
  - 語意功能：可作為「儀式光環／能量場」的母題，易被子代轉置為背景的場域性裝置。
- offspring_20250925_133130_766.png
  - 背景繼承 DSCF4385 的放射圖騰；前景為裸上身人形，頭部被針葉狀植被取代（人—植物混種）。
  - 敘事策略：以文化圖騰做聖像式光環，匿名化人像承載集體心理與原型敘事。
- offspring_20250924_150915_655.png
  - 夜間場景、三名男子背向觀者，遠處紅光作聚焦；低彩暗場＋局部高亮紅光，具電影感與硬閃殘影。
  - 方法論回應：「夜遊」中的臨場與召喚，光源既是拍攝方法痕跡亦是圖像內部事件。

語彙標籤建議（向量檢索輔助）：
- DSCF4385.jpg：radial fold, ritual paper pattern, yellow-red high saturation, symbolic motif, center vortex, repetitive pattern
- offspring_20250925_133130_766.png：human-plant hybrid, saintly halo background, ritual motif, anonymous figure, foliage head
- offspring_20250924_150915_655.png：night scene, three men back view, red flare, hard-flash aura, low-key cinematic

可驗證假說（結合前述量化）：
- 含放射圖騰父圖的子代，其色相向紅/黃傾斜、中心亮度權重更集中。
- 回授比例（offspring 作父圖）升高的批次，亮度對比與邊緣密度呈收斂趨勢。
- 「匿名化人像」將在向量空間形成聚類，可透過 CLIP 向量＋HDBSCAN/UMAP 驗證。

策展與生成提示：
- 以 DSCF4385 支系為「儀式圖騰分支」母干，固定共親（圖騰＋植被/人體/火光）觀察表型穩定度。
- 聚焦「匿名化人像」子系：背影、去頭換植、遮蔽臉部等，搭配圖騰或夜間火光形成展牆敘事。

### 個案：offspring_20251012_183708_098.png（第 13 代）
- 父圖：
  - `offspring_20251012_183147_226.png`（舞台簾幕、單眼聚光、漂浮人形的構圖骨架）
  - `offspring_20251005_145509_385.png`（餐桌儀式、粉紅魚、骨架參與者、上方雲團）
  - `offspring_20251012_181503_997.png`（前景黑貓、夜間硬閃的前景語彙）
  - `wc6725_resimulate_this_unfinished_image_...a06f1f52....png`（宇宙夜空與超現實構圖模板）
- 視覺與象徵：
  - 三層空間：黑貓門檻（前景）／餐桌獻祭（中景）／宇宙舞台與監視之眼（後景）。
  - 垂直視線：眼→光束→桌上魚與貓；「監視—啟示—獻祭」。
  - 人像策略：面具化、骨架參與者，延續 projectP 的儀式群像語彙。
- 快速特徵值（PIL 估算，四捨五入）：
  - 子圖 mean_l=0.266, mean_s=0.273, edge=0.049, halo=0.073
  - 父圖對照：
    - 183147：mean_l=0.242, mean_s=0.273, edge=0.043, halo=0.132
    - 145509：mean_l=0.281, mean_s=0.191, edge=0.060, halo=0.283
    - 181503：mean_l=0.338, mean_s=0.239, edge=0.076, halo=-0.084
  - 解讀：色彩飽和與簾幕父圖一致；中心光環較餐桌父圖柔化；黑貓父圖原本中心偏暗，子圖以舞台光束校正。
- 語義標籤：
  - theater curtains, all-seeing eye spotlight, ritual dinner table, skeleton participant, pink fish offering, masked figures in red jumpsuits, floating patterned bodies, black cat green eyes, starry night stage, surreal ceremony

## 15. Metadata 衍生欄位與標註範例
為利檢索與解釋，建議在 metadata 增列或另建索引（如 `backend/metadata/index.json`）：

```json
{
  "output_image": "offspring_20250925_133130_766.png",
  "created_at": "2025-09-25T05:31:30.768Z",
  "parents": ["DSCF4385.jpg", "wc6725_resimulate_this_picture_...png"],
  "model_name": "gemini-2.5-flash-image-preview",
  "lineage_depth": 2,
  "parent_type_stats": {"photo": 1, "ai": 1, "offspring": 0},
  "semantic_tags": ["human-plant hybrid", "ritual motif", "halo background", "anonymous figure"],
  "visual_features": {
    "mean_luminance": 0.42,
    "edge_density": 0.31,
    "dominant_hue_bin": 1
  },
  "attractor_flags": {"radial_totem": true, "anonymous_portrait": true}
}
```

備註：`semantic_tags` 由人工與自動標註混合；`attractor_flags` 用以標記像 DSCF4385 這類高頻「吸引子」語彙。上述欄位可先以外部索引檔維護，避免改動既有單檔 metadata。 

## 16. 分支專題：projectP 圖像群
範圍與產量
- 目錄：`夜遊 - 毛刺/projectP/`，共 176 張，其中 offspring 101、wc6725_* 種子 74；無缺漏 metadata（全數可對應）。
- 生成時段：2025-10-04（19張）→ 10-05（26）→ 10-06（35）→ 10-07（16）→ 10-12（5）。集中於 10/4–10/7，屬一個高強度創作期。

親緣結構（僅統計 offspring）
- 父圖數分佈：3 張（42 次）最常見；其後 5 張（34 次）、4 張（13 次）、2 張（12 次）。
- 父圖類型：AI（wc6725_*）≈ 230、offspring ≈ 142，幾乎不含實拍 photo 直接參與，屬「純合成」分支。
- 高頻父圖來源：多個 wc6725_* 種子重覆 5–8 次，並有少量同期間 offspring 互為父圖（如 `offspring_20251005_142805_666.png` 等）。
- 共親配對：以 wc×wc 或 wc×offspring 為主；顯示在「種子庫內循環」的重組策略。

多模態視覺語彙（代表案例）
- 沙漠浮游群像：漂浮的細長形擬人與器官化生物、光環頭像、稀疏地平線與長陰影；低彩背景＋點綴式飽和紅粉。
- 餐桌儀式場景：雕花木桌、異色桌布（渦紋/佩斯利）、白膚無髮人形、紅衣主持與黑獸於上空；空間具舞台式佈景感。
- 禪坐師者與宇宙卷軸：中央坐像、滿版圓渦紋路、周邊漂浮的星體/器官/幽靈；強烈平面化裝飾感與細密點描。

形式與色彩語法
- 平面化插畫風、細節以圓渦/佩斯利/點狀構成；人物為簡化比例、拉長四肢、白膚無髮的匿名原型。
- 調色：背景偏去飽和（灰、沙、墨），主體以紅、粉、黃、藍的高飽和紋飾搶眼；常見黑色動物/幽靈作對比錨點。
- 構圖：中央聖像（坐像/主持）＋周緣群象與漂浮物；上方常有「黑色主體」懸置，形成壓頂張力。

與主系譜的關係與假說
- 由於不直接使用實拍 photo，projectP 的風格受「AI 種子吸引子」主導，呈現強烈插畫/民俗—宇宙混成語彙。
- 圓渦/佩斯利與先前「放射圖騰」屬同型動機（circle-based attractor），但來源傾向 wc 種子而非 DSCF 實拍。
- 重組策略以 wc×wc、wc×offspring 為主，推測更易在語義上產生「超自然生靈」「餐桌儀式」「坐像聖像」等穩定子系。

檢索標籤（建議加入 semantic_tags）
- 主題：desert floaters, ritual dinner, seated sage, black beast overhead, spirit swarm
- 物件：paisley tablecloth, carved wooden table, halo head, eyeball motif, elongated limbs, bald white figures, cat under table
- 調性：flat illustrative, decorative dots, circular swirls, muted background + saturated accents

策展與製作建議
- 以「三幕」呈現：沙漠群像／餐桌儀式／坐像宇宙卷軸；每幕挑選 6–9 張並附家譜小圖（顯示 wc 種子組合）。
- 生成策略：固定 1–2 個高頻 wc 種子為骨幹，輪替 1–2 個當期 offspring 作弱突變，維持表型一致性下的細節變奏。
- 向量檢索：先在語義層以上述標籤與 CLIP 向量過濾，再在系譜層展開相鄰父/同輩/子代，供策展挑選敘事路徑。

## 17. 統計觀察與吸引子（全庫）
深度與規模
- 最深世代：第 13 代（樣本：`offspring_20251012_183708_098.png`）。
- 深度分佈：1(507), 2(228), 3(156), 4(93), 5(40), 6(36), 7(33), 8(28), 9(12), 10(6), 11(3), 12(1), 13(1)。

混圖複雜度趨勢（僅觀察、暫不調參）
- 平均父圖數與深度：深度1→2.69、2→3.07、3→2.88、5→3.40、7→3.82（極深層樣本稀少，僅供參考）。
- 邊緣密度（抽樣每層 ≤30 張）：深度1≈0.088 → 深度9–10≈0.105，呈現逐步增密；符合「混圖回授→元素堆疊」的特性。

影響力父圖（吸引子）
- 直接子代數 Top（擇要）：
  - DSCF4385.jpg(45)、offspring_20250928_203748_266.png(34)
  - wc6725_A_vast_crowd_of_East_Asian_people_in_black_suits_converg_...png(25)
  - wc6725_resimulate_this_picture_with_a_milder_content__5cbc8c9a-...png(23)
  - DSCF7655.jpg(21)、DSCF4159.jpg(21)、wc6725__484d31f2-...png(21)
- 多層後代閉包 Top（擇要）：
  - wc6725_resimulate_this_picture_with_a_milder_content_hdvbccbxxv_dd0a7746-...png(174)
  - wc6725_resimulate_this_picture_with_a_milder_content__5c13767e-...png(165)
  - offspring_20251004_220333_675.png(151)
  - 另有多個 wc6725_* 種子於 120–140 量級。

共親網路（類型與配對）
- 類型混搭次序：ai+ai > ai+offspring > offspring+offspring > photo+photo > ai+photo > offspring+photo。
- 高頻配對（擇要）：
  - DSCF4385.jpg × DSCF7655.jpg(15)
  - DSCF4385.jpg × wc6725_A_vast_crowd_of_East_Asian_people_in_black_suits_converg_...png(14)
  - offspring_20250927_115953_059.png × wc6725_A_vast_crowd_of_...png(11)
  - 另有 offspring × offspring 的固定組合若干。

日別節奏（date, total, mean_parents, offspring_parent_ratio）
- 2025-10-04：173, 2.58, 0.24（大量新種子注入的創始期）
- 2025-10-05：89, 3.92, 0.79（回授升高）
- 2025-10-06：121, 3.88, 0.88（快速回授）
- 2025-10-07：25, 3.56, 0.92（回授高位）
- 另：2025-09-24：172, 2.47, 0.52；2025-09-28：26, 2.00, 0.96；2025-10-08：132, 3.48, 0.21（再次創始）。

備註
- projectP 外延（見第 16 節）：以 101 張為種子在主庫長出 270 張後代（深度1：268、深度2：2），符合上列「創始→回授」節奏。

## 18. 開放式探索指標（首批驗證）
為快速捕捉混圖帶來的視覺效應，先以每層抽樣（≤20/層）估算下列簡易特徵：

- 負空間比（low-edge ratio，越高代表留白越多）：
  - 深度1≈0.767，2≈0.781，4≈0.782，7≈0.750，9≈0.720，10≈0.736
  - 解讀：中淺層普遍留白仍高；到深層略為下降（畫面更滿），但整體仍維持 0.72–0.78 的高留白區間。

- 色相熵（Hue Entropy，36-bin）：
  - 深度1≈3.19，2≈3.64，4≈3.69，7≈3.48，10≈3.38
  - 解讀：第 2–4 代顏色分佈更分散（熵較高），之後略回落；對應「注入→回授」間色彩語彙先擴散後局部凝聚。

- 邊緣方向各向異性（Anisotropy，0~1）：
  - 深度1≈0.062，2≈0.085，4≈0.060，7≈0.056，10≈0.031
  - 解讀：第 2 代附近出現較強的方向性紋理（可能來自線性裝飾/構圖），深層又趨於均衡（滿版紋理化）。

說明：上述為 PIL 快取版本（不依賴重型 FFT）；後續可在不影響工作流下，逐步擴展到全庫與更細緻的頻譜分析、圖案家族分群與場景原型分類。

## 19. 拼貼（Collage Version）匹配模式與視覺耦合

本階段加入多種切片匹配模式，目的在於「讓親緣元素於單張圖內重新編隊」，觀察語彙如何在微結構（tile 邊界）與宏結構（區塊）上形成可辨識的型態。所有模式均在 `backend/app/services/collage_version.py` 中實作，前端 `CollageVersionMode` 提供介面選擇。

- 模式清單（摘要）：
  - `kinship`：以邊緣顏色距離作貪婪匹配，偏好與已放置鄰居色彩接近者；局部縫合最佳。
  - `luminance`：最小化亮度差（鄰居/基底）；產生強烈的明暗節律（垂直柱狀常見）。
  - `wave`：由中心向外的 BFS 順序放置；形成方向性條帶。
  - `source-cluster`：以來源圖為單位設置種子，對最近種子區域優先放同源 tile（同源加權）；會長出語義連續的大區塊。
  - `random`：基準對照，僅保證種子重現性。

耦合機制（由低到高）：
- 低階：邊緣平均色、中心色、亮度分佈（對應 `compute_edge_colors`、`compute_tile_luminance`）。
- 中階：局部紋理密度（由色差近似，尚未直接引入方向/頻譜）；在 wave/order 效應下產生條帶。
- 高階（視覺辨識觀察）：裂紋/石面、深紅布料、乾草枝葉、光滑灰面、膚色手部、樹影等趨向成為可辨認的圖像母題，在 `source-cluster` 內聚成塊，在 `luminance` 中被亮度節奏化。

對照樣本（同一父圖集合、12×16、seed=927322）：
- `backend/offspring_images/offspring_20251108_231524_549.png`（kinship）
- `backend/offspring_images/offspring_20251108_231542_136.png`（luminance）
- `backend/offspring_images/offspring_20251108_231555_088.png`（random）
- `backend/offspring_images/offspring_20251108_231501_329.png`（wave）
- `backend/offspring_images/offspring_20251108_231510_992.png`（source-cluster）

視覺樣貌（重點）：
- 裂紋/石面：在 `source-cluster` 形成連續縱向帶；在 `luminance` 成為中亮度柱狀單元；在 `random` 破碎四散。
- 深紅布料：在 `luminance` 被周期性插入為紅色節拍；在 `source-cluster` 可形成完整紅色區塊/帶。
- 乾草/枝葉：`wave` 與 `kinship` 內沿條帶/鄰接逐步織入；`random` 無聚合。
- 光滑灰面：由於「無鄰居時以灰為參考」的啟發式，`kinship` 與 `source-cluster` 早期插槽常出現大塊淺灰（如十字/角落）。

連到前文（吸引子與系譜）：
- 我們先前在第 17–18 節提出「吸引子（attractors）」與開放指標。新的拼貼模式提供「在單張內」觀察吸引子聚合的機制：
  - `source-cluster` = 語彙在空間上被來源驅動而聚塊，對應「基因群落」的視覺化。
  - `luminance` = 同一語彙被亮度節奏打散成韻律單元，利於估測明暗主旋律在系譜中的演化。
  - `wave/kinship` = 以鄰接相容和順序造成「帶狀/縫合」吸引子。

## 20. 可量測的耦合證據（實驗設計）

為避免純主觀描述，建議在 `return_map=true` 取得 tile 對應後，計算下列指標：

- 邊界縫合度（Seam Coherence）：沿每條 tile 邊取梯度差（Sobel/Scharr）之均值；越低代表縫合越好。
- 來源純度（Source Homogeneity）：計算相鄰 tile 同源比例；`source-cluster` 應顯著高於其他模式。
- 區塊一致性（Zone Consistency）：以同源鄰接做連通區，再算區內 Lab 方差與面積分佈；檢驗是否真有大區塊聚合。
- 方向連續性（Orientation Coherence）：在 seam 上做結構張量/HoG 方向相似度，檢驗裂紋/樹影等方向紋理是否跨格延續。
- 灰度啟動偏壓（Gray Bias Footprint）：統計前 N% 放置槽其中心 Lab 與中性點的距離；評估灰色大塊的成因與規模。

再現協定（前端/後端）：
- 透過 `POST /api/generate-collage-version` 指定 `mode`, `rows`, `cols`, `seed`, `return_map=true`。
- 以同一 `image_names[]`、同一 `rows×cols`、同一 `seed`，只改 `mode`，生成五張對照。
- 使用 `GET /api/collage-version/{task_id}/progress` 取得完成訊息與 `tile_mapping`；將 mapping 與指標結果寫入對應的 `metadata` 條目，便於系譜疊合。

## 21. 針對模式的微調建議（保持風格，降低副作用）

- `source-cluster`
  - 同源加權：由 0.5 的乘數改為 0.7–0.85，並加入「跨源但 seam 分數更佳」的小額加分，讓邊界更自然。
  - 種子選位：由幾何分區改為對 base 圖 Lab/紋理 k-means 後挑選質心，避免大塊淺灰十字。
- `luminance`
  - 次級色相約束：在亮度一致時，偏好色相距離較近者，減少純紅/純灰的周期性柱狀。
- `wave`
  - 前沿對齊：在前沿插值中加入邊緣方向相似度（orientation term），使條帶內紋理更順。
- `kinship`
  - 起始插槽灰偏壓：將「無鄰居時對灰」改為「對應 base tile 中心色」，或以退火方式逐步降低此權重。

## 22. 與系譜視覺化的接合

- metadata 擴展（已有）：`collage_params.mode/rows/cols/seed/...`。建議在 `return_map=true` 時新增：
  - `tile_mapping`: `[ {row, col, source_image, source_row, source_col} ]`
  - `zone_stats`: 依上節計算後寫回（可為簡要統計），供 lineage viewer 疊加高亮某一來源的佔比與區塊。
- 視覺化提案：
  - 前端疊層：滑桿切換顯示「來源著色」（同源著色相同顏色）、「縫合熱度圖」（seam error）。
  - 系譜路徑：在展示某個父圖時，標出其在後代拼貼中的「佔比、區塊位置與形狀」。

## 23. 後續工作與里程碑（延續第 18 節）

1. 完成五模式×N 組父圖的固定參數對照庫，並產出上述四大指標（seam/同源/方向/灰偏）。
2. 於 `backend/metadata` 為對照庫補寫 `zone_stats`，並在 viewer 端提供疊層檢視。
3. 以吸引子角度回寫「圖像母題」標籤（裂路、紅布、乾草、樹影、手部），驗證在不同模式下的聚散趨勢。
4. 以系譜為軸的場景編排：從某吸引子祖先→多模式後代→策展三分屏（聚塊/節律/縫合）。
5. 規劃一個「模式建議器」：根據父圖組合的 Lab/紋理概況，自動推薦預設模式與參數（rows/cols/seed）。

## 24. 時序 × 系譜 × 技法 × 視覺（整合敘事）

- 早期（9/23–9/25｜photo 為主 → 夜景敘事＋發光圖騰）
  - 系譜：父圖多為夜遊實拍（如 `DSCF4385.jpg`），偶有單一 AI 種子輔助。
  - 技法：夜景硬閃／長曝感、中心放射或渦旋圖騰覆寫自然物。
  - 視覺：深色背景＋橘紅發光；具前後景深與場域敘事。
  - 範例：`backend/offspring_images/offspring_20250923_171114_325.png`、`backend/offspring_images/deprecated/offspring_20250923_172330_091.png`。

- 中期（10/04–10/12｜offspring × wc 種子混生 → 舞台化拼貼）
  - 系譜：同日/相鄰日 offspring 互為父圖，並與 `wc6725_*` 大量混配；回授比例升高。
  - 技法：提示詞轉向「重置布局／再舞台化」，但實作偏拼貼、插畫化與裝飾性渦紋。
  - 視覺：直幅為主、元素密度提升、黑色生物/面具群像等符號學加重。
  - 範例：`backend/offspring_images/offspring_20251006_201113_520.png`、`backend/offspring_images/offspring_20251008_193120_384.png`。

- 晚期（11/08–11/09｜多後代拼貼 → 親緣紋理與故障美學）
  - 系譜：metadata 註明 `generation_type:"collage"`，一次使用 3–8 張以上 offspring；可回引 9 月的早期作品作父圖。
  - 技法：`rows:40 / cols:40 / mode:"kinship" / base:"first" / resize_w≈2048` 的格網重組；以相近紋理/明度拼接，形成斜向流紋與顆粒化外觀。
  - 視覺：具體物 → 純紋理的轉換；解析度與檔案尺寸顯著上升；少量輸出呈現全黑或條帶（需標記為可疑）。
  - 範例：`backend/offspring_images/offspring_20251108_152255_091.png`、`backend/offspring_images/offspring_20251109_124953_469.png`。

- 連續性與轉譯（吸引子如何變形）
  - 「放射圖騰」（早期的中心聖徽）→ 在晚期被瓦解成大面積橘紅流紋（見 11/09 範例）。
  - 「匿名人物／面具群」→ 中期符號化聚集，晚期解體為膚色顆粒，僅留節律。
  - 「夜色冷暖對比」→ 在晚期轉為灰階×暖橘的微塊分佈，保留色溫張力但失去具象敘事。

- 風格—技術映射表（口訣速覽）
  - 夜景圖騰感：photo + `overlay-halo` → 聖像／儀式光環（敘事強、母題完整）。
  - 舞台拼貼感：offspring×wc + `restage-compose`/`mask-montage` → 插畫化群像（符號密度高、縫合感可見）。
  - 親緣紋理感：多 offspring + `collage-kinship(rows*cols↑)` → 斜向流紋與顆粒（敘事弱、解析度高）。

## 25. 異常輸出與檔案治理（晚期新增）

- 問題類型
  - 近乎全黑（例：`backend/offspring_images/offspring_20251108_140310_263.png`）。
  - 條帶或大面積分塊與空洞（例：`backend/offspring_images/offspring_20251109_000031_441.png`）。
- 建議處理
  - 在 metadata 增 `status: "suspect"` 與 `period: "late"`、`style_flags: ["glitch","mosaic"]`。
  - 集中搬運至 `backend/offspring_images/suspect_corrupted/`（或建立軟連結），避免混入策展清單，同時保留研究價值。
  - 在 collage 程序加入「最小可視內容檢查」（如非黑像素比例、局部對比閾值）。

## 26. 失聯情境的系譜推理（無 metadata 亦可）

- 目標：當缺 metadata 或父圖路徑不可得時，僅憑圖像推測其所屬技法期與可能父源。
- 判定順序（規則集）
  1) 是否有規則格網與斜向流紋？是 → `collage-kinship` 晚期。
  2) 是否舞台化、元素多而縫合痕明顯、直幅？是 → 中期 `restage/蒙太奇`。
  3) 是否暗場＋中心發光圖騰或硬閃痕？是 → 早期 `overlay-halo`。
  4) 解析度 > 2K 且直幅固定 → 晚期可能性升高。
  5) 出現 projectP 標誌物（黑獸、圓渦、坐像）→ 中期偏高。
- 父源線索
  - photo 痕跡：真實鏡頭像差、景深、閃光反光；
  - wc 種子：圖案化紋理與特定配色（沙灰底＋粉紅/黃/藍點綴）；
  - offspring 回授：前述兩者的語彙被反覆折疊、凝聚。
